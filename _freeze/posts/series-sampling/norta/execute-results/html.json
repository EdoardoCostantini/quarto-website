{
  "hash": "5e988b4a4e91798ee38f97023896c532",
  "result": {
    "markdown": "---\ndraft: false\ntitle: Normal to anything (NORTA) sampling\nauthor: Edoardo Costantini\ndate: '2022-10-26'\nslug: norta\ncategories: [\"distributions\"]\nbibliography: ../../resources/bibshelf.bib\n---\n\n\n# Introduction\n\nThe Normal to anything (or NORTA) is a sampling approach that allows the generation of multivariate data with a known rank correlation structure and arbitrary marginal distributions.\nFor example, you could generate 2 variables $X_1$ and $X_2$ with a given rank correlation and [beta](https://en.wikipedia.org/wiki/Beta_distribution) marginal distributions.\nThe only requirement is that the target marginal distributions need to be continuous distributions with a known [(inverse) cumulative distribution function](https://en.wikipedia.org/wiki/Quantile_function).\n\n# Learn by coding\n\nFor this topic we will need a few packages:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load pacakges ---------------------------------------------------------------\n\nlibrary(SimCorMultRes)\nlibrary(MASS)\nlibrary(ggplot2)\nlibrary(ggExtra) # for marginal plots\nlibrary(e1071)\nlibrary(sn) # for skewed normal distribution\n```\n:::\n\n\nThe NORTA approach can be summarized in three steps:\n\n  1. Sample a data matrix $X_{n \\times p}$ from a Multivariate Normal distribution with target correlation structure\n  2. Transform the distributions of the individual variables $x_j$ for $j = 1, \\dots, p$ (the marginal distributions) to a uniform distribution by applying the normal [CDF](https://en.wikipedia.org/wiki/Cumulative_distribution_function) to $X$ (in R `pnorm()`)\n  3. Transform the uniform marginals to any continuous target distributions by applying the inverse CDF of the target distribution (usually implemented in R by a `qtarget()` function, for example, `qbeta`)\n\n## 1. Sample from a multivariate normal distribution\n\nFirst, we sample 1000 observations from a multivariate normal distribution with four correlated variables ($\\rho = .7$).\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 1. Sample from multivariate normal distribution -----------------------------\n\n# Set the seed\nset.seed(20210422)\n\n# Fix parameters\nn <- 1e3 # smaple size\np <- 2  # number of variables\nmu <- rep(0, p) # vector of means\nSigma <- matrix(.7, nrow = p, ncol = p); diag(Sigma) <- 1 # correlation matrix\n\n# Sample Multivariate Normal data\nX <- mvrnorm(n = n, mu = mu, Sigma = Sigma)\n```\n:::\n\n\nWe can then plot a scatterplot of $X_1$ and $X_2$ to study their multivariate distribution and make the marginal plots visible.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Plot the multivariate distribution (scatterplot)\nX_scatter <- ggplot(data.frame(X), aes(x = X1, y = X2)) +\n      geom_point()\n\n# Add marginals of X\nggMarginal(X_scatter, type = \"histogram\") \n```\n\n::: {.cell-output-display}\n![](norta_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n:::\n\n\nWe can now transform the marginal distributions of the $x$s to any target continuous distribution.\n\n## 2. Transform normal marginals into uniform\n\nFor example, consider transforming the marginals to a beta distribution. \n\nFirst, we compute the values of the normal cumulative distribution function (`pnorm()`).\n\n::: {.cell}\n\n```{.r .cell-code}\n# 2. Transform marginals to a uniform distribution -----------------------------\n\n# Transform to uniform distribution (apply normal CDF to X)\nU <- pnorm(X) \n\n# Make scatterplot\nU_scatter <- ggplot(data.frame(U), aes(x = X1, y = X2)) +\n      geom_point()\n\n# Add marginals of U\nggMarginal(U_scatter, type = \"histogram\") \n```\n\n::: {.cell-output-display}\n![](norta_files/figure-html/uniform-1.png){width=672}\n:::\n:::\n\n\n## 3. Transform uniform marginals into anything\n\nThen we compute the quantiles corresponding to the resulting cumulative probabilities based on the target marginal distribution using the `qbeta()` function.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 3. Transform marginals to anything with a (inverse) CDF ----------------------\n\n# > 3.1 Beta -------------------------------------------------------------------\n\n# Transform to a beta distribution\nX_beta <- qbeta(U, shape1 = .5, shape2 = .5)\n\n# And visualize\nX_beta_scatter <- ggplot(data.frame(X_beta), aes(x = X1, y = X2)) +\n      geom_point()\nggMarginal(X_beta_scatter, type = \"histogram\") \n```\n\n::: {.cell-output-display}\n![](norta_files/figure-html/beta-1.png){width=672}\n:::\n:::\n\n\nAs another example, consider transforming the marginal to a highly skewed T distribution.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# > 3.2 Skewed-t distribution --------------------------------------------------\n\n# Define the target skewness and kurtosis\nsk <- -2\nkt <- 10\n\n# Define direct parameterization for the skew-t (ST) distribution\ncpST <- c(0, 1, sk, kt)\ndpST <- cp2dp(cpST, family = \"ST\")\n\n# Transform to Skew-t (apply target inverse-CDF to X)\nX_st <- apply(U, 2, qst, dp = dpST)\n\n# And visualize\nX_st_scatter <- ggplot(data.frame(X_st), aes(x = X1, y = X2)) +\n      geom_point()\nggMarginal(X_st_scatter, type = \"histogram\") \n```\n\n::: {.cell-output-display}\n![](norta_files/figure-html/skew-1.png){width=672}\n:::\n:::\n\n\n### 3.1 Preserved multivariate relationships\n\nUpon generating the multivariate data $\\mathbf{X}$, the association between the two variables $X_1$ and $X_2$ is determined by the correlation coefficient $\\rho$ that we used in the `mvrnorm()` call.\nThis coefficient expresses the linear dependence between the two variables which is not preserved when non-linear transformations are applied to the marginals (which we use).\nHowever, the NORTA approach does preserve [rank correlations](https://en.wikipedia.org/wiki/Rank_correlation) between the variables.\nIn the following code, we compute the Pearson correlation (linear dependency), and the Spearman and Kendall's correlations (rank correlations) for the original data, and all other transformations.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Collect all sampled datasets\ndats <- list(X = X, U = U, skewt = X_st, beta = X_beta)\n\n# Compute all types of correlation on all datasets\nround(\n      data.frame(\n            Pearson = sapply(dats, function(i) cor(i, method = \"pearson\")[1,2]),\n            Spearman = sapply(dats, function(i) cor(i, method = \"spearman\")[1,2]),\n            Kendall = sapply(dats, function(i) cor(i, method = \"kendall\")[1,2])\n      ), 3\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n      Pearson Spearman Kendall\nX       0.684    0.666   0.476\nU       0.667    0.666   0.476\nskewt   0.663    0.666   0.476\nbeta    0.644    0.666   0.476\n```\n:::\n:::\n\n\nAs you can see, the NORTA sampling approach allows us to easily sample dependent multivariate data with arbitrary marginal distributions and known target (rank) correlations.\n\n### 3.2 Discrete distributions\n\nOne can be tempted to use any marginal distribution, even discrete distributions. However, the rank correlation is not preserved when this marginal transformation is applied.\nConsider for example transforming the marginals to Poisson distributions:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# > 3.3 Poissan distribution ---------------------------------------------------\n\n# Transform to poissan (apply target inverse-CDF to X)\nX_pois <- qpois(U, lambda = 2)\n\n# And visualize\nX_pois_scatter <- ggplot(data.frame(X_pois), aes(x = X1, y = X2)) +\n      geom_point()\nggMarginal(X_pois_scatter, type = \"histogram\") \n```\n\n::: {.cell-output-display}\n![](norta_files/figure-html/poissan-1.png){width=672}\n:::\n:::\n\n\nor to binomial distributions\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# > 3.4 Binomial distribution ---------------------------------------------------\n\n# Transform to binomial\nX_binom <- qbinom(U, size = 6, prob = .2)\n\n# And visualize\nX_binom_scatter <- ggplot(data.frame(X_binom), aes(x = X1, y = X2)) +\n      geom_point()\nggMarginal(X_binom_scatter, type = \"histogram\") \n```\n\n::: {.cell-output-display}\n![](norta_files/figure-html/binomial-1.png){width=672}\n:::\n:::\n\n\nif you check again both the linear and rank correlations you will notice that both have been impacted by these transformations:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Add the other datasets\ndats <- list(\n            X = X, \n            U = U, \n            skewt = X_st, \n            beta = X_beta, \n            poissan = X_pois, \n            binomial = X_binom\n)\n\n# Compute all types of correlation on all datasets\nround(\n      data.frame(\n            Pearson = sapply(dats, function(i) cor(i, method = \"pearson\")[1,2]),\n            Spearman = sapply(dats, function(i) cor(i, method = \"spearman\")[1,2]),\n            Kendall = sapply(dats, function(i) cor(i, method = \"kendall\")[1,2])\n      ), 3\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n         Pearson Spearman Kendall\nX          0.684    0.666   0.476\nU          0.667    0.666   0.476\nskewt      0.663    0.666   0.476\nbeta       0.644    0.666   0.476\npoissan    0.644    0.635   0.535\nbinomial   0.620    0.605   0.535\n```\n:::\n:::\n\n\n# TL;DR, just give me the code!\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load pacakges ---------------------------------------------------------------\n\nlibrary(SimCorMultRes)\nlibrary(MASS)\nlibrary(ggplot2)\nlibrary(ggExtra) # for marginal plots\nlibrary(e1071)\nlibrary(sn) # for skewed normal distribution\n\n# 1. Sample from multivariate normal distribution -----------------------------\n\n# Set the seed\nset.seed(20210422)\n\n# Fix parameters\nn <- 1e3 # smaple size\np <- 2  # number of variables\nmu <- rep(0, p) # vector of means\nSigma <- matrix(.7, nrow = p, ncol = p); diag(Sigma) <- 1 # correlation matrix\n\n# Sample Multivariate Normal data\nX <- mvrnorm(n = n, mu = mu, Sigma = Sigma)\n\n# Plot the multivariate distribution (scatterplot)\nX_scatter <- ggplot(data.frame(X), aes(x = X1, y = X2)) +\n      geom_point()\n\n# Add marginals of X\nggMarginal(X_scatter, type = \"histogram\") \n\n# 2. Transform marginals to a uniform distribution -----------------------------\n\n# Transform to uniform distribution (apply normal CDF to X)\nU <- pnorm(X) \n\n# Make scatterplot\nU_scatter <- ggplot(data.frame(U), aes(x = X1, y = X2)) +\n      geom_point()\n\n# Add marginals of U\nggMarginal(U_scatter, type = \"histogram\") \n\n# 3. Transform marginals to anything with a (inverse) CDF ----------------------\n\n# > 3.1 Beta -------------------------------------------------------------------\n\n# Transform to a beta distribution\nX_beta <- qbeta(U, shape1 = .5, shape2 = .5)\n\n# And visualize\nX_beta_scatter <- ggplot(data.frame(X_beta), aes(x = X1, y = X2)) +\n      geom_point()\nggMarginal(X_beta_scatter, type = \"histogram\") \n\n# > 3.2 Skewed-t distribution --------------------------------------------------\n\n# Define the target skewness and kurtosis\nsk <- -2\nkt <- 10\n\n# Define direct parameterization for the skew-t (ST) distribution\ncpST <- c(0, 1, sk, kt)\ndpST <- cp2dp(cpST, family = \"ST\")\n\n# Transform to Skew-t (apply target inverse-CDF to X)\nX_st <- apply(U, 2, qst, dp = dpST)\n\n# And visualize\nX_st_scatter <- ggplot(data.frame(X_st), aes(x = X1, y = X2)) +\n      geom_point()\nggMarginal(X_st_scatter, type = \"histogram\") \n\n# Collect all sampled datasets\ndats <- list(X = X, U = U, skewt = X_st, beta = X_beta)\n\n# Compute all types of correlation on all datasets\nround(\n      data.frame(\n            Pearson = sapply(dats, function(i) cor(i, method = \"pearson\")[1,2]),\n            Spearman = sapply(dats, function(i) cor(i, method = \"spearman\")[1,2]),\n            Kendall = sapply(dats, function(i) cor(i, method = \"kendall\")[1,2])\n      ), 3\n)\n\n# > 3.3 Poissan distribution ---------------------------------------------------\n\n# Transform to poissan (apply target inverse-CDF to X)\nX_pois <- qpois(U, lambda = 2)\n\n# And visualize\nX_pois_scatter <- ggplot(data.frame(X_pois), aes(x = X1, y = X2)) +\n      geom_point()\nggMarginal(X_pois_scatter, type = \"histogram\") \n\n# > 3.4 Binomial distribution ---------------------------------------------------\n\n# Transform to binomial\nX_binom <- qbinom(U, size = 6, prob = .2)\n\n# And visualize\nX_binom_scatter <- ggplot(data.frame(X_binom), aes(x = X1, y = X2)) +\n      geom_point()\nggMarginal(X_binom_scatter, type = \"histogram\") \n\n# Add the other datasets\ndats <- list(\n            X = X, \n            U = U, \n            skewt = X_st, \n            beta = X_beta, \n            poissan = X_pois, \n            binomial = X_binom\n)\n\n# Compute all types of correlation on all datasets\nround(\n      data.frame(\n            Pearson = sapply(dats, function(i) cor(i, method = \"pearson\")[1,2]),\n            Spearman = sapply(dats, function(i) cor(i, method = \"spearman\")[1,2]),\n            Kendall = sapply(dats, function(i) cor(i, method = \"kendall\")[1,2])\n      ), 3\n)\n```\n:::\n\n\n# References\n\n## Online resources\n[SAS blogs: introduction to copulas](https://blogs.sas.com/content/iml/2021/07/05/introduction-copulas.html)\n[Simulating Dependent Random Variables Using Copulas](https://www.mbfys.ru.nl/~robvdw/CNP04/LAB_ASSIGMENTS/LAB05_CN05/MATLAB2007b/stats/html/copulademo.html)",
    "supporting": [
      "norta_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}