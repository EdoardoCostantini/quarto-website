<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Edoardo Costantini">
<meta name="dcterms.date" content="2022-06-13">

<title>Edoardo Costantini - Implementing a PLS alogirthm in R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Edoardo Costantini</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-digital-garden" role="button" data-bs-toggle="dropdown" aria-expanded="false">Digital garden</a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-digital-garden">    
        <li>
    <a class="dropdown-item" href="../../all-posts.html">
 <span class="dropdown-text">All posts</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../series-pca.html">
 <span class="dropdown-text">A primer on PCA</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../series-sm-course.html">
 <span class="dropdown-text">Course: Statistics and Methodology</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../series-sampling.html">
 <span class="dropdown-text">Sampling</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../research.html">Research</a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Implementing a PLS alogirthm in R</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">Supervised learning</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Edoardo Costantini </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">June 13, 2022</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#popular-algorithms-to-implement-pls" id="toc-popular-algorithms-to-implement-pls" class="nav-link" data-scroll-target="#popular-algorithms-to-implement-pls">Popular algorithms to implement PLS</a></li>
  </ul></li>
  <li><a href="#learn-by-coding" id="toc-learn-by-coding" class="nav-link" data-scroll-target="#learn-by-coding">Learn by coding</a>
  <ul class="collapse">
  <li><a href="#coding-the-pls-algorithm-manually" id="toc-coding-the-pls-algorithm-manually" class="nav-link" data-scroll-target="#coding-the-pls-algorithm-manually">Coding the PLS algorithm manually</a></li>
  <li><a href="#types-of-dependent-variables" id="toc-types-of-dependent-variables" class="nav-link" data-scroll-target="#types-of-dependent-variables">Types of dependent variables</a></li>
  <li><a href="#prediction-of-new-data" id="toc-prediction-of-new-data" class="nav-link" data-scroll-target="#prediction-of-new-data">Prediction of new data</a></li>
  <li><a href="#degrees-of-freedom-of-the-residuals" id="toc-degrees-of-freedom-of-the-residuals" class="nav-link" data-scroll-target="#degrees-of-freedom-of-the-residuals">Degrees of freedom of the residuals</a></li>
  </ul></li>
  <li><a href="#tldr-just-give-me-the-code" id="toc-tldr-just-give-me-the-code" class="nav-link" data-scroll-target="#tldr-just-give-me-the-code">TL;DR, just give me the code!</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Many data analysts face the problem of analyzing data sets with many, often highly correlated, variables. Partial Least Square Regression (PLSR) is a regression method that uses linear combinations of the original predictors to reduce their dimensionality. As principal component regression, PLS uses derived inputs, however, it differs from PCR by how the linear combinations are constructed.</p>
<p>Given a set of predictors <span class="math inline">\(X_{n \times p}\)</span> and a vector of dependent variable scores <span class="math inline">\(y_{n \times 1}\)</span>, the least-square solution for the multiple linear regression</p>
<p><span class="math display">\[
y = X \beta + \epsilon\text{, with } \epsilon \sim N(0, \sigma^2)
\]</span></p>
<p>is</p>
<p><span class="math display">\[
\beta = (X'X)^{-1}X'y
\]</span></p>
<p>where <span class="math inline">\(X'\)</span> is the transpose of the data matrix <span class="math inline">\(X\)</span>, and <span class="math inline">\(()^{-1}\)</span> is the matrix inverse. When collinearity is present in <span class="math inline">\(X\)</span> or <span class="math inline">\(p &gt; n\)</span>, then <span class="math inline">\(X'X\)</span> is singular and its inverse cannot be computed. Derived input regression methods like PCR and PLSR bypass this problem by taking linear combinations of the columns of the original <span class="math inline">\(X\)</span> and regressing <span class="math inline">\(Y\)</span> on just a few of these linear combinations. The peculiarity of PLSR is that it includes information on both <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> in the definition of the linear combinations. In this post, we look at two algorithms to estimate PLSR to get a better understanding of the method.</p>
<section id="popular-algorithms-to-implement-pls" class="level2">
<h2 class="anchored" data-anchor-id="popular-algorithms-to-implement-pls">Popular algorithms to implement PLS</h2>
<p>Here, I describe informally the algorithm steps:</p>
<ol type="1">
<li>Preprocessing the data - the columns of the input matrix <span class="math inline">\(X\)</span> are standardized to have mean 0 and variance 1.</li>
<li>The cross-product of every column of <span class="math inline">\(X\)</span> and <span class="math inline">\(y\)</span> is computed: <span class="math inline">\(\rho_{1j} = x_{j}' y\)</span> for <span class="math inline">\(j = 1, \dots, p\)</span>.</li>
<li>Compute the first partial-least-square direction <span class="math inline">\(z_1\)</span> - The cross-products <span class="math inline">\(\rho_{1j}\)</span> are used as weights to obtain a linear combination of the columns: <span class="math inline">\(z_1 = \sum \rho_{1j} x_{j}\)</span>. This implies that the contribution of each column to <span class="math inline">\(z_1\)</span> is weighted by their univariate relationship with the dependent variable <span class="math inline">\(y\)</span>.</li>
<li>Regression of <span class="math inline">\(y\)</span> on <span class="math inline">\(z_1\)</span> - The outcome variable <span class="math inline">\(y\)</span> is regressed on this first direction <span class="math inline">\(z_1\)</span> to obtain <span class="math inline">\(\hat{\theta}_1\)</span>.</li>
<li>Orthogonalization of <span class="math inline">\(X\)</span> - All columns of <span class="math inline">\(X\)</span> are orthogonalized with respect to <span class="math inline">\(z_1\)</span>.</li>
<li>The cross-product of every column of <span class="math inline">\(X\)</span> and <span class="math inline">\(y\)</span> is computed again: <span class="math inline">\(\rho_{2j} = x_{j}' y\)</span> for <span class="math inline">\(j = 1, \dots, p\)</span>.</li>
<li>Compute the second partial-least-square direction <span class="math inline">\(z_2\)</span> - The cross-products <span class="math inline">\(\rho_{2j}\)</span> are used as weights to obtain a linear combination of the columns: <span class="math inline">\(z_2 = \sum \rho_{2j} x_{j}\)</span>. Notice that the columns <span class="math inline">\(x_j\)</span> we are using now are orthogonal to the previous partial least square direction <span class="math inline">\(z_1\)</span>.</li>
<li>Regression of <span class="math inline">\(y\)</span> on <span class="math inline">\(z_2\)</span> - The outcome variable <span class="math inline">\(y\)</span> is regressed on the second direction <span class="math inline">\(z_2\)</span> to obtain <span class="math inline">\(\hat{\theta}_2\)</span>.</li>
<li>Orthogonalization of <span class="math inline">\(X\)</span> - All columns of <span class="math inline">\(X\)</span> are orthogonalized with respect to <span class="math inline">\(z_2\)</span>.</li>
</ol>
<p>The procedure continues until <span class="math inline">\(M\)</span> partial least square directions have been computed. The result is a set of independent directions that have both high variance and high correlation with the dependent variable, in contrast to PCR which finds a set of independent directions that have high variance.</p>
<p>Now we report pseudo-code for the implementation of the PLS algorithm (inspired by Report Algorithm 3.3 p.103 as in <span class="citation" data-cites="hastieEtAl:2015">(<a href="#ref-hastieEtAl:2015" role="doc-biblioref">Hastie, Tibshirani, and Wainwright 2015</a>)</span>). We will use it to write the R code in the next session.</p>
<ol type="1">
<li>Standardized each <span class="math inline">\(x_j\)</span> to have mean 0 and variance 1</li>
<li>Set:
<ul>
<li><span class="math inline">\(\hat{y}^{(0)} = \bar{y}1\)</span></li>
<li><span class="math inline">\(x_{j}^{(0)} = x_{j}\)</span></li>
</ul></li>
<li>For <span class="math inline">\(m = 1, 2, \dots, M\)</span>
<ol type="a">
<li><span class="math inline">\(z_m = \sum_{j = 1}^{p} \rho_{mj}x_{j}^{(m-1)}\)</span></li>
<li><span class="math inline">\(\hat{\theta}_m = \frac{z_m'y}{z_m' z_m}\)</span></li>
<li><span class="math inline">\(\hat{y}^{(m)} = \hat{y}^{(m-1)} + \hat{\theta}_m z_m\)</span></li>
<li>for <span class="math inline">\(j = 1, \dots, p\)</span> orthogonalize <span class="math inline">\(x_{j}\)</span> with respect to <span class="math inline">\(z_m\)</span>: <span class="math inline">\(x_{j}^{(m)} = x_{j}^{(m-1)} - \frac{z_m' x_{j}^{(m)}}{z_m' z_m}z_m\)</span></li>
</ol></li>
<li>Output the sequence of fitted vectors <span class="math inline">\(\hat{y}^{m}\)</span></li>
</ol>
</section>
</section>
<section id="learn-by-coding" class="level1">
<h1>Learn by coding</h1>
<div class="cell">

</div>
<p>We start by loading a package already implementing the PLS algorithm and some data to test our code. We load the <code>PCovR</code> package to use the <code>alexithymia</code> data which reports the scores of 122 Blegian psychology stundets on three scales:</p>
<ul>
<li>20-item Toronto Alexithymia Scale (TAS-20) measuring the inability to recognize emotions.</li>
<li>Center for Epidemiological Studies Depression Scale (CES-D) measuring depression.</li>
<li>Rosenberg Self-Esteem Scale (RSE).</li>
</ul>
<p>The main objective of the data collection was to asssess how well TAS-20 can predict depression and self-esteem<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load packages ----------------------------------------------------------------</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># load packages</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(PCovR)  <span class="co"># for data</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pls)    <span class="co"># for pls algorithm</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plsdof) <span class="co"># for pls algorithm</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(alexithymia)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Devide in X and y</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> alexithymia<span class="sc">$</span>X</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> alexithymia<span class="sc">$</span>Y<span class="sc">$</span>RSE</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Count the number of variables and observations</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the number of directions we will use</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>M <span class="ot">&lt;-</span> <span class="dv">10</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="coding-the-pls-algorithm-manually" class="level2">
<h2 class="anchored" data-anchor-id="coding-the-pls-algorithm-manually">Coding the PLS algorithm manually</h2>
<p>Let’s go through the steps described in the pseudo code above. First we want to standardize the predictors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Standardize the data ------------------------------------------------------</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scale the predictors</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    Xstd <span class="ot">&lt;-</span> <span class="fu">scale</span>(X)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Means of X are now 0</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cbind</span>(</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">X =</span> <span class="fu">head</span>(<span class="fu">colMeans</span>(X)), </span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">Xstd =</span> <span class="fu">round</span>(<span class="fu">head</span>(<span class="fu">colMeans</span>(Xstd)), <span class="dv">5</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                         X Xstd
confused         1.8196721    0
right words      1.7950820    0
sensations       0.5983607    0
describe         2.2213115    0
analyze problems 2.5081967    0
upset            1.6065574    0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SD of X are now 1</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cbind</span>(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">X =</span> <span class="fu">head</span>(<span class="fu">apply</span>(X, <span class="dv">2</span>, sd)),</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">Xstd =</span> <span class="fu">round</span>(<span class="fu">head</span>(<span class="fu">apply</span>(Xstd, <span class="dv">2</span>, sd)), <span class="dv">5</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                        X Xstd
confused         1.178431    1
right words      1.278807    1
sensations       1.073034    1
describe         1.216364    1
analyze problems 1.077539    1
upset            1.295621    1</code></pre>
</div>
</div>
<p>Then we want to set the intial values</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Set initial vlaues --------------------------------------------------------</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2a: Set the initial prediction for y_hat to the mean of y</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create an empty data.frame to store the initial value and future predictions</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    yhat_m <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="cn">NA</span>, n <span class="sc">*</span> (M <span class="sc">+</span> <span class="dv">1</span>)), <span class="at">nrow =</span> n)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Replace the initial prediction with the mean of y</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    yhat_m[, <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">mean</span>(y)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2b: Set every xj0 to xj</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create an empty list of X values</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    Xm <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>(M <span class="sc">+</span> <span class="dv">1</span>), matrix, <span class="at">nrow =</span> n, <span class="at">ncol =</span> p)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Place X as initial value for Xm</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    Xm[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(Xstd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we can move to the estimation step. First we create the number</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Estimation ----------------------------------------------------------------</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preparing objects</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> n, <span class="at">ncol =</span> (M <span class="sc">+</span> <span class="dv">1</span>)) <span class="co"># container for directions</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    W <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> p, <span class="at">ncol =</span> (M <span class="sc">+</span> <span class="dv">1</span>)) <span class="co"># container for directions</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    theta_hat <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, (M <span class="sc">+</span> <span class="dv">1</span>)) <span class="co"># container for thetas</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then we move to the proper estimation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PLS Algorithm following HastieEtAl2017 p 81 (Algorithm 3.3)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (m <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>(M <span class="sc">+</span> <span class="dv">1</span>)) {</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 3a: Compute zm</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        W[, m] <span class="ot">&lt;-</span> <span class="fu">t</span>(Xm[[m <span class="sc">-</span> <span class="dv">1</span>]]) <span class="sc">%*%</span> y   <span class="co"># inner products / covariances</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        W <span class="sc">/</span> n</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>        z[, m] <span class="ot">&lt;-</span> Xm[[m <span class="sc">-</span> <span class="dv">1</span>]] <span class="sc">%*%</span> W[, m] <span class="co"># compute the direction zm</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 3b: Compute regression coefficient for y ~ Zm</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        theta_hat[m] <span class="ot">&lt;-</span> <span class="fu">drop</span>(<span class="fu">t</span>(z[, m]) <span class="sc">%*%</span> y <span class="sc">/</span> <span class="fu">t</span>(z[, m]) <span class="sc">%*%</span> z[, m])</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 3c: Compute predicted y with the current m directions</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        yhat_m[, m] <span class="ot">&lt;-</span> yhat_m[, m <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">+</span> theta_hat[m] <span class="sc">*</span> z[, m]</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 3d: Orthogonalize all columns of X with respect to zm</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p) {</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>            Xm[[m]][, j] <span class="ot">&lt;-</span> <span class="fu">orthogonalize</span>(Xm[[m<span class="dv">-1</span>]][, j], z[, m])</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit PLSR model w/ pls package</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    pls_fit_pls <span class="ot">&lt;-</span> pls<span class="sc">::</span><span class="fu">plsr</span>(</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        y <span class="sc">~</span> <span class="fu">as.matrix</span>(X),</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">ncomp =</span> M,</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">method =</span> <span class="st">"oscorespls"</span>,</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">validation =</span> <span class="st">"none"</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit PCR model w/ plsdof package</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    pls_fit_plsdof <span class="ot">&lt;-</span> plsdof<span class="sc">::</span><span class="fu">pls.model</span>(<span class="fu">as.matrix</span>(Xstd), y)</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    pls_fit_plsdof<span class="sc">$</span>coefficients[, <span class="dv">3</span><span class="sc">+</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] -0.77322985 -0.55969544  0.44823243  0.42519983 -0.82981915  0.27264689
 [7] -0.88380881  0.07420445 -0.24761114  0.10450986 -0.06604870  0.52244833
[13] -1.67949848 -0.88035012 -0.90311608  0.28814506  0.11064435  0.51922786
[19]  0.94014053 -0.62037921</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compare predictions using up to a given m</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    m <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">data.frame</span>(</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">pls =</span> <span class="fu">round</span>(<span class="fu">as.data.frame</span>(<span class="fu">fitted</span>(pls_fit_pls)), <span class="dv">3</span>)[, m],</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">plsdof =</span> <span class="fu">round</span>(pls_fit_plsdof<span class="sc">$</span>Yhat, <span class="dv">3</span>)[, m <span class="sc">+</span> <span class="dv">1</span>],</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">man =</span> <span class="fu">round</span>(yhat_m, <span class="dv">3</span>)[, m <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     pls plsdof    man
1 36.809 36.819 36.819
2 29.231 29.243 29.243
3 31.197 31.336 31.336
4 30.902 30.767 30.767
5 35.186 34.869 34.869
6 25.087 24.876 24.876</code></pre>
</div>
</div>
</section>
<section id="types-of-dependent-variables" class="level2">
<h2 class="anchored" data-anchor-id="types-of-dependent-variables">Types of dependent variables</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Types of DVs -----------------------------------------------------------------</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data</span>(oliveoil)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    sens.pcr <span class="ot">&lt;-</span> pls<span class="sc">::</span><span class="fu">pcr</span>(sensory <span class="sc">~</span> chemical, <span class="at">ncomp =</span> <span class="dv">4</span>, <span class="at">scale =</span> <span class="cn">TRUE</span>, <span class="at">data =</span> oliveoil)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    sens.pls <span class="ot">&lt;-</span> pls<span class="sc">::</span><span class="fu">plsr</span>(sensory <span class="sc">~</span> chemical, <span class="at">ncomp =</span> <span class="dv">4</span>, <span class="at">scale =</span> <span class="cn">TRUE</span>, <span class="at">data =</span> oliveoil)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    oliveoil<span class="sc">$</span>sensory</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   yellow green brown glossy transp syrup
G1   21.4  73.4  10.1   79.7   75.2  50.3
G2   23.4  66.3   9.8   77.8   68.7  51.7
G3   32.7  53.5   8.7   82.3   83.2  45.4
G4   30.2  58.3  12.2   81.1   77.1  47.8
G5   51.8  32.5   8.0   72.4   65.3  46.5
I1   40.7  42.9  20.1   67.7   63.5  52.2
I2   53.8  30.4  11.5   77.8   77.3  45.2
I3   26.4  66.5  14.2   78.7   74.6  51.8
I4   65.7  12.1  10.3   81.6   79.6  48.3
I5   45.0  31.9  28.4   75.7   72.9  52.8
S1   70.9  12.2  10.8   87.7   88.1  44.5
S2   73.5   9.7   8.3   89.9   89.7  42.3
S3   68.1  12.0  10.8   78.4   75.1  46.4
S4   67.6  13.9  11.9   84.6   83.8  48.5
S5   71.4  10.6  10.8   88.1   88.5  46.7
S6   71.4  10.0  11.4   89.5   88.5  47.2</code></pre>
</div>
</div>
</section>
<section id="prediction-of-new-data" class="level2">
<h2 class="anchored" data-anchor-id="prediction-of-new-data">Prediction of new data</h2>
<p>How do we predict new data? Let’s start by generating data form scratch</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prediction -------------------------------------------------------------------</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="dv">50</span> <span class="co"># number of observations</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="dv">15</span> <span class="co"># number of variables</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    X <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n <span class="sc">*</span> p), <span class="at">ncol =</span> p)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="sc">+</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    M <span class="ot">&lt;-</span> <span class="dv">10</span> <span class="co"># number of "components"</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    ntest <span class="ot">&lt;-</span> <span class="dv">200</span> <span class="co">#</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    Xtest <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(ntest <span class="sc">*</span> p), <span class="at">ncol =</span> p) <span class="co"># test data</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    ytest <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(ntest) <span class="co"># test data</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit alternative PLSs</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    out_pls <span class="ot">&lt;-</span> pls<span class="sc">::</span><span class="fu">plsr</span>(</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>        y <span class="sc">~</span> X,</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">ncomp =</span> M,</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">scale =</span> <span class="cn">TRUE</span>,</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">center =</span> <span class="cn">TRUE</span>,</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">method =</span> <span class="st">"oscorespls"</span>,</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">validation =</span> <span class="st">"none"</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    out_plsdof <span class="ot">&lt;-</span> plsdof<span class="sc">::</span><span class="fu">pls.model</span>(X, y, <span class="at">compute.DoF =</span> <span class="cn">TRUE</span>, <span class="at">Xtest =</span> Xtest, <span class="at">ytest =</span> <span class="cn">NULL</span>)</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Obtain predictions on new data</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>        <span class="fu">round</span>(</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>            <span class="fu">cbind</span>(</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>                <span class="at">PLS =</span> <span class="fu">predict</span>(out_pls, <span class="at">newdata =</span> Xtest)[, , M],</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>                <span class="at">PLSdof =</span> out_plsdof<span class="sc">$</span>prediction[, M <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>            ), <span class="dv">5</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           PLS    PLSdof
[1,]  99.91546  99.91546
[2,] 100.52518 100.52518
[3,] 100.61482 100.61482
[4,]  99.81698  99.81698
[5,] 100.38015 100.38015
[6,] 100.76092 100.76092</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make sure scale of prediction is correct</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    out_pls_cF <span class="ot">&lt;-</span> <span class="fu">plsr</span>(</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>      y <span class="sc">~</span> X,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">ncomp =</span> M,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">scale =</span> <span class="cn">TRUE</span>,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">center =</span> <span class="cn">FALSE</span>,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">method =</span> <span class="st">"oscorespls"</span>,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">validation =</span> <span class="st">"none"</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    Xs <span class="ot">&lt;-</span> <span class="fu">scale</span>(X, <span class="at">center =</span> <span class="cn">TRUE</span>, <span class="at">scale =</span> <span class="cn">FALSE</span>)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    ys <span class="ot">&lt;-</span> <span class="fu">scale</span>(y, <span class="at">center =</span> <span class="cn">FALSE</span>, <span class="at">scale =</span> <span class="cn">FALSE</span>)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    out_pls_cF <span class="ot">&lt;-</span> <span class="fu">plsr</span>(</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>      ys <span class="sc">~</span> Xs,</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">ncomp =</span> M,</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">scale =</span> <span class="cn">TRUE</span>,</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">center =</span> <span class="cn">FALSE</span>,</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">method =</span> <span class="st">"oscorespls"</span>,</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">validation =</span> <span class="st">"none"</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">round</span>(</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cbind</span>(</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>            <span class="at">PLS =</span> <span class="fu">predict</span>(out_pls, <span class="at">newdata =</span> Xtest)[, , M],</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>            <span class="at">PLS_cf =</span> <span class="fu">mean</span>(y) <span class="sc">+</span> <span class="fu">predict</span>(out_pls_cF, <span class="at">newdata =</span> Xtest)[, , M],</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>            <span class="at">PLSdof =</span> out_plsdof<span class="sc">$</span>prediction[, M]</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>        ), <span class="dv">5</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           PLS    PLS_cf    PLSdof
[1,]  99.91546  99.83684  99.91662
[2,] 100.52518 100.44656 100.52460
[3,] 100.61482 100.53620 100.61432
[4,]  99.81698  99.73836  99.81537
[5,] 100.38015 100.30153 100.37996
[6,] 100.76092 100.68230 100.76126</code></pre>
</div>
</div>
</section>
<section id="degrees-of-freedom-of-the-residuals" class="level2">
<h2 class="anchored" data-anchor-id="degrees-of-freedom-of-the-residuals">Degrees of freedom of the residuals</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># PLS degrees of freedom -------------------------------------------------------</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(plsdof)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate data data</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="co"># number of observations</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="dv">15</span> <span class="co"># number of variables</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    m <span class="ot">&lt;-</span> <span class="dv">15</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    X <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n <span class="sc">*</span> p), <span class="at">ncol =</span> p)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit model with package</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    outpls <span class="ot">&lt;-</span> <span class="fu">pls.model</span>(X, y, <span class="at">compute.DoF =</span> <span class="cn">TRUE</span>)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    outpls<span class="sc">$</span>DoF</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    outpls.internal <span class="ot">&lt;-</span> <span class="fu">linear.pls.fit</span>(X, y, m, <span class="at">DoF.max =</span> <span class="fu">min</span>(n <span class="sc">-</span> <span class="dv">1</span>, p <span class="sc">+</span> <span class="dv">1</span>))</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit model with person PLS function</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    outpls_man <span class="ot">&lt;-</span> <span class="fu">pls.manual</span>(<span class="at">ivs =</span> X, <span class="at">dv =</span> y, <span class="at">m =</span> m)</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit model with plsr function from pls</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    pls_fit_pls <span class="ot">&lt;-</span> <span class="fu">plsr</span>(</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>        y <span class="sc">~</span> X,</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">ncomp =</span> m,</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">scale =</span> <span class="cn">FALSE</span>,</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">center =</span> <span class="cn">FALSE</span>,</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">method =</span> <span class="st">"oscorespls"</span>,</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">validation =</span> <span class="st">"none"</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Y hats</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(outpls_man<span class="sc">$</span>Yhat <span class="sc">-</span> outpls<span class="sc">$</span>Yhat, <span class="dv">5</span>)</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># T scores</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>    j <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cbind</span>(</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>        <span class="at">PLSR =</span> <span class="fu">apply</span>(<span class="fu">scores</span>(pls_fit_pls), <span class="dv">2</span>, <span class="cf">function</span>(j) j <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(j<span class="sc">^</span><span class="dv">2</span>)))[, j],</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>        <span class="at">PLSTT =</span> outpls.internal<span class="sc">$</span>TT[, j],</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>        <span class="at">manualTs =</span> outpls_man<span class="sc">$</span>Ts[, j],</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>        <span class="at">manualTsn =</span> outpls_man<span class="sc">$</span>Tsn[, j]</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Degrees of freedom PLSR</span></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>    predi <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span>m, <span class="cf">function</span>(j) {</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>        <span class="fu">predict</span>(pls_fit_pls, <span class="at">ncomp =</span> j)</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>    DoF_plsr <span class="ot">&lt;-</span> <span class="fu">dofPLS</span>(</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>        X,</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>        y,</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>        <span class="at">TT =</span> <span class="fu">apply</span>(<span class="fu">scores</span>(pls_fit_pls), <span class="dv">2</span>, <span class="cf">function</span>(j) j <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(j<span class="sc">^</span><span class="dv">2</span>))),</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>        <span class="at">Yhat =</span> predi,</span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>        <span class="at">DoF.max =</span> m <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Degrees of freedom manual</span></span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>    DoF_manual <span class="ot">&lt;-</span> <span class="fu">dofPLS</span>(</span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>        X,</span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>        y,</span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>        <span class="at">TT =</span> outpls_man<span class="sc">$</span>Tsn,</span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>        <span class="at">Yhat =</span> outpls_man<span class="sc">$</span>Yhat[, <span class="dv">2</span><span class="sc">:</span>(m <span class="sc">+</span> <span class="dv">1</span>)],</span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>        <span class="at">DoF.max =</span> m <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Single DoF</span></span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a>    DoF_single <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span>m, <span class="cf">function</span>(i) {</span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a>        <span class="fu">dofPLS_single</span>(</span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a>            X,</span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a>            y,</span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a>            <span class="at">TT =</span> outpls_man<span class="sc">$</span>Tsn,</span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a>            <span class="at">Yhat =</span> outpls_man<span class="sc">$</span>Yhat[, (i <span class="sc">+</span> <span class="dv">1</span>)],</span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a>            <span class="at">q =</span> i</span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a>    }))</span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compare degrees of freedom</span></span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cbind</span>(</span>
<span id="cb18-77"><a href="#cb18-77" aria-hidden="true" tabindex="-1"></a>        <span class="at">PLSR =</span> DoF_plsr,</span>
<span id="cb18-78"><a href="#cb18-78" aria-hidden="true" tabindex="-1"></a>        <span class="at">PLSdof =</span> outpls<span class="sc">$</span>DoF,</span>
<span id="cb18-79"><a href="#cb18-79" aria-hidden="true" tabindex="-1"></a>        <span class="at">PLS_manual =</span> DoF_manual,</span>
<span id="cb18-80"><a href="#cb18-80" aria-hidden="true" tabindex="-1"></a>        <span class="at">diff =</span> <span class="fu">round</span>(outpls<span class="sc">$</span>DoF <span class="sc">-</span> DoF_manual, <span class="dv">5</span>),</span>
<span id="cb18-81"><a href="#cb18-81" aria-hidden="true" tabindex="-1"></a>        <span class="at">DoF_single =</span> DoF_single</span>
<span id="cb18-82"><a href="#cb18-82" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="tldr-just-give-me-the-code" class="level1">
<h1>TL;DR, just give me the code!</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Functions needed ----------------------------------------------------------------</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Degrees of freedom for supervised derived input models</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>dofPLS <span class="ot">&lt;-</span> <span class="cf">function</span>(X, y, TT, Yhat, <span class="at">m =</span> <span class="fu">ncol</span>(X), <span class="at">DoF.max =</span> <span class="fu">ncol</span>(X) <span class="sc">+</span> <span class="dv">1</span>){</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Example inputs</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># X = scale(mtcars[, -1])</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># y = mtcars[, 1]</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># m = ncol(X)</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># DoF.max = m + 1</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># TT &lt;- linear.pls.fit(X, y, m, DoF.max = DoF.max)$TT # normalizezs PC scores</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Yhat &lt;- linear.pls.fit(X, y, m, DoF.max = DoF.max)$Yhat[, 2:(m + 1)]</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Body</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scale data</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    mean.X <span class="ot">&lt;-</span> <span class="fu">apply</span>(X, <span class="dv">2</span>, mean)</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    sd.X <span class="ot">&lt;-</span> <span class="fu">apply</span>(X, <span class="dv">2</span>, sd)</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    sd.X[sd.X <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    X <span class="ot">&lt;-</span> X <span class="sc">-</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(X)) <span class="sc">%*%</span> <span class="fu">t</span>(mean.X)</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    X <span class="ot">&lt;-</span> X <span class="sc">/</span> (<span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(X)) <span class="sc">%*%</span> <span class="fu">t</span>(sd.X))</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    K <span class="ot">&lt;-</span> X <span class="sc">%*%</span> <span class="fu">t</span>(X)</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># pls.dof</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    DoF.max <span class="ot">&lt;-</span> DoF.max <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    TK <span class="ot">&lt;-</span> <span class="fu">matrix</span>(, m, m)</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    KY <span class="ot">&lt;-</span> <span class="fu">krylov</span>(K, K <span class="sc">%*%</span> y, m)</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    lambda <span class="ot">&lt;-</span> <span class="fu">eigen</span>(K)<span class="sc">$</span>values</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    tr.K <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">length =</span> m)</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m) {</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>        tr.K[i] <span class="ot">&lt;-</span> <span class="fu">sum</span>(lambda<span class="sc">^</span>i)</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>    BB <span class="ot">&lt;-</span> <span class="fu">t</span>(TT) <span class="sc">%*%</span> KY</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>    BB[<span class="fu">row</span>(BB) <span class="sc">&gt;</span> <span class="fu">col</span>(BB)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> <span class="fu">t</span>(TT) <span class="sc">%*%</span> y</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>    DoF <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">length =</span> m)</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>    Binv <span class="ot">&lt;-</span> <span class="fu">backsolve</span>(BB, <span class="fu">diag</span>(m))</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>    tkt <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, m)</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>    ykv <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, m)</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>    KjT <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="at">dim =</span> <span class="fu">c</span>(m, n, m))</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>    dummy <span class="ot">&lt;-</span> TT</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m) {</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>        dummy <span class="ot">&lt;-</span> K <span class="sc">%*%</span> dummy</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>        KjT[i, , ] <span class="ot">&lt;-</span> dummy</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>    trace.term <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, m)</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m) {</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>        Binvi <span class="ot">&lt;-</span> Binv[<span class="dv">1</span><span class="sc">:</span>i, <span class="dv">1</span><span class="sc">:</span>i, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>        ci <span class="ot">&lt;-</span> Binvi <span class="sc">%*%</span> b[<span class="dv">1</span><span class="sc">:</span>i]</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>        Vi <span class="ot">&lt;-</span> TT[, <span class="dv">1</span><span class="sc">:</span>i, drop <span class="ot">=</span> <span class="cn">FALSE</span>] <span class="sc">%*%</span> <span class="fu">t</span>(Binvi)</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>        trace.term[i] <span class="ot">&lt;-</span> <span class="fu">sum</span>(ci <span class="sc">*</span> tr.K[<span class="dv">1</span><span class="sc">:</span>i])</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>        ri <span class="ot">&lt;-</span> y <span class="sc">-</span> Yhat[, i]</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>i) {</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>            KjTj <span class="ot">&lt;-</span> KjT[j, , ]</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>            tkt[i] <span class="ot">&lt;-</span> tkt[i] <span class="sc">+</span> ci[j] <span class="sc">*</span> <span class="fu">tr</span>(<span class="fu">t</span>(TT[, <span class="dv">1</span><span class="sc">:</span>i, <span class="at">drop =</span> <span class="cn">FALSE</span>]) <span class="sc">%*%</span></span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>                KjTj[, <span class="dv">1</span><span class="sc">:</span>i, <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>            ri <span class="ot">&lt;-</span> K <span class="sc">%*%</span> ri</span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>            ykv[i] <span class="ot">&lt;-</span> ykv[i] <span class="sc">+</span> <span class="fu">sum</span>(ri <span class="sc">*</span> Vi[, j])</span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a>    DoF <span class="ot">&lt;-</span> trace.term <span class="sc">+</span> <span class="dv">1</span><span class="sc">:</span>m <span class="sc">-</span> tkt <span class="sc">+</span> ykv</span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>    DoF[DoF <span class="sc">&gt;</span> DoF.max] <span class="ot">&lt;-</span> DoF.max</span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a>    DoF <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, DoF) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">: check that it is correct to add the 1 after checking the DoF max condition</span></span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a>    DoF</span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract single factor --------------------------------------------------------</span></span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a>dofPLS_single <span class="ot">&lt;-</span> <span class="cf">function</span>(X, y, <span class="at">q =</span> <span class="dv">1</span>, TT, Yhat){</span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Example inputs</span></span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># X = scale(mtcars[, -1])</span></span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># y = mtcars[, 1]</span></span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># m = ncol(X)</span></span>
<span id="cb19-80"><a href="#cb19-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># DoF.max = m + 1</span></span>
<span id="cb19-81"><a href="#cb19-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># TT &lt;- linear.pls.fit(X, y, m, DoF.max = DoF.max)$TT # normalizezs PC scores</span></span>
<span id="cb19-82"><a href="#cb19-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># q &lt;- 3 # desired component / latent variable</span></span>
<span id="cb19-83"><a href="#cb19-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Yhat &lt;- linear.pls.fit(X, y, m, DoF.max = DoF.max)$Yhat[, (q + 1)]</span></span>
<span id="cb19-84"><a href="#cb19-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-85"><a href="#cb19-85" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Body</span></span>
<span id="cb19-86"><a href="#cb19-86" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X)</span>
<span id="cb19-87"><a href="#cb19-87" aria-hidden="true" tabindex="-1"></a>    m <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X)</span>
<span id="cb19-88"><a href="#cb19-88" aria-hidden="true" tabindex="-1"></a>    DoF.max <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb19-89"><a href="#cb19-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-90"><a href="#cb19-90" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scale data</span></span>
<span id="cb19-91"><a href="#cb19-91" aria-hidden="true" tabindex="-1"></a>    mean.X <span class="ot">&lt;-</span> <span class="fu">apply</span>(X, <span class="dv">2</span>, mean)</span>
<span id="cb19-92"><a href="#cb19-92" aria-hidden="true" tabindex="-1"></a>    sd.X <span class="ot">&lt;-</span> <span class="fu">apply</span>(X, <span class="dv">2</span>, sd)</span>
<span id="cb19-93"><a href="#cb19-93" aria-hidden="true" tabindex="-1"></a>    sd.X[sd.X <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb19-94"><a href="#cb19-94" aria-hidden="true" tabindex="-1"></a>    X <span class="ot">&lt;-</span> X <span class="sc">-</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(X)) <span class="sc">%*%</span> <span class="fu">t</span>(mean.X)</span>
<span id="cb19-95"><a href="#cb19-95" aria-hidden="true" tabindex="-1"></a>    X <span class="ot">&lt;-</span> X <span class="sc">/</span> (<span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(X)) <span class="sc">%*%</span> <span class="fu">t</span>(sd.X))</span>
<span id="cb19-96"><a href="#cb19-96" aria-hidden="true" tabindex="-1"></a>    K <span class="ot">&lt;-</span> X <span class="sc">%*%</span> <span class="fu">t</span>(X)</span>
<span id="cb19-97"><a href="#cb19-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-98"><a href="#cb19-98" aria-hidden="true" tabindex="-1"></a>    <span class="co"># pls.dof</span></span>
<span id="cb19-99"><a href="#cb19-99" aria-hidden="true" tabindex="-1"></a>    DoF.max <span class="ot">&lt;-</span> DoF.max <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb19-100"><a href="#cb19-100" aria-hidden="true" tabindex="-1"></a>    TK <span class="ot">&lt;-</span> <span class="fu">matrix</span>(, m, m)</span>
<span id="cb19-101"><a href="#cb19-101" aria-hidden="true" tabindex="-1"></a>    KY <span class="ot">&lt;-</span> <span class="fu">krylov</span>(K, K <span class="sc">%*%</span> y, m)</span>
<span id="cb19-102"><a href="#cb19-102" aria-hidden="true" tabindex="-1"></a>    lambda <span class="ot">&lt;-</span> <span class="fu">eigen</span>(K)<span class="sc">$</span>values</span>
<span id="cb19-103"><a href="#cb19-103" aria-hidden="true" tabindex="-1"></a>    tr.K <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">length =</span> m)</span>
<span id="cb19-104"><a href="#cb19-104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m) {</span>
<span id="cb19-105"><a href="#cb19-105" aria-hidden="true" tabindex="-1"></a>        tr.K[i] <span class="ot">&lt;-</span> <span class="fu">sum</span>(lambda<span class="sc">^</span>i)</span>
<span id="cb19-106"><a href="#cb19-106" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-107"><a href="#cb19-107" aria-hidden="true" tabindex="-1"></a>    BB <span class="ot">&lt;-</span> <span class="fu">t</span>(TT) <span class="sc">%*%</span> KY</span>
<span id="cb19-108"><a href="#cb19-108" aria-hidden="true" tabindex="-1"></a>    BB[<span class="fu">row</span>(BB) <span class="sc">&gt;</span> <span class="fu">col</span>(BB)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb19-109"><a href="#cb19-109" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> <span class="fu">t</span>(TT) <span class="sc">%*%</span> y</span>
<span id="cb19-110"><a href="#cb19-110" aria-hidden="true" tabindex="-1"></a>    DoF <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">length =</span> m)</span>
<span id="cb19-111"><a href="#cb19-111" aria-hidden="true" tabindex="-1"></a>    Binv <span class="ot">&lt;-</span> <span class="fu">backsolve</span>(BB, <span class="fu">diag</span>(m))</span>
<span id="cb19-112"><a href="#cb19-112" aria-hidden="true" tabindex="-1"></a>    tkt <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb19-113"><a href="#cb19-113" aria-hidden="true" tabindex="-1"></a>    ykv <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb19-114"><a href="#cb19-114" aria-hidden="true" tabindex="-1"></a>    KjT <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="at">dim =</span> <span class="fu">c</span>(q, n, m))</span>
<span id="cb19-115"><a href="#cb19-115" aria-hidden="true" tabindex="-1"></a>    dummy <span class="ot">&lt;-</span> TT</span>
<span id="cb19-116"><a href="#cb19-116" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>q) {</span>
<span id="cb19-117"><a href="#cb19-117" aria-hidden="true" tabindex="-1"></a>        dummy <span class="ot">&lt;-</span> K <span class="sc">%*%</span> dummy</span>
<span id="cb19-118"><a href="#cb19-118" aria-hidden="true" tabindex="-1"></a>        KjT[i, , ] <span class="ot">&lt;-</span> dummy</span>
<span id="cb19-119"><a href="#cb19-119" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-120"><a href="#cb19-120" aria-hidden="true" tabindex="-1"></a>    trace.term <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb19-121"><a href="#cb19-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-122"><a href="#cb19-122" aria-hidden="true" tabindex="-1"></a>    Binvi <span class="ot">&lt;-</span> Binv[<span class="dv">1</span><span class="sc">:</span>q, <span class="dv">1</span><span class="sc">:</span>q, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb19-123"><a href="#cb19-123" aria-hidden="true" tabindex="-1"></a>    ci <span class="ot">&lt;-</span> Binvi <span class="sc">%*%</span> b[<span class="dv">1</span><span class="sc">:</span>q]</span>
<span id="cb19-124"><a href="#cb19-124" aria-hidden="true" tabindex="-1"></a>    Vi <span class="ot">&lt;-</span> TT[, <span class="dv">1</span><span class="sc">:</span>q, drop <span class="ot">=</span> <span class="cn">FALSE</span>] <span class="sc">%*%</span> <span class="fu">t</span>(Binvi)</span>
<span id="cb19-125"><a href="#cb19-125" aria-hidden="true" tabindex="-1"></a>    trace.term <span class="ot">&lt;-</span> <span class="fu">sum</span>(ci <span class="sc">*</span> tr.K[<span class="dv">1</span><span class="sc">:</span>q])</span>
<span id="cb19-126"><a href="#cb19-126" aria-hidden="true" tabindex="-1"></a>    ri <span class="ot">&lt;-</span> y <span class="sc">-</span> Yhat</span>
<span id="cb19-127"><a href="#cb19-127" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>q) {</span>
<span id="cb19-128"><a href="#cb19-128" aria-hidden="true" tabindex="-1"></a>        KjTj <span class="ot">&lt;-</span> KjT[j, , ]</span>
<span id="cb19-129"><a href="#cb19-129" aria-hidden="true" tabindex="-1"></a>        tkt <span class="ot">&lt;-</span> tkt <span class="sc">+</span> ci[j] <span class="sc">*</span> <span class="fu">tr</span>(<span class="fu">t</span>(TT[, <span class="dv">1</span><span class="sc">:</span>q, <span class="at">drop =</span> <span class="cn">FALSE</span>]) <span class="sc">%*%</span></span>
<span id="cb19-130"><a href="#cb19-130" aria-hidden="true" tabindex="-1"></a>            KjTj[, <span class="dv">1</span><span class="sc">:</span>q, <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb19-131"><a href="#cb19-131" aria-hidden="true" tabindex="-1"></a>        ri <span class="ot">&lt;-</span> K <span class="sc">%*%</span> ri</span>
<span id="cb19-132"><a href="#cb19-132" aria-hidden="true" tabindex="-1"></a>        ykv <span class="ot">&lt;-</span> ykv <span class="sc">+</span> <span class="fu">sum</span>(ri <span class="sc">*</span> Vi[, j])</span>
<span id="cb19-133"><a href="#cb19-133" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-134"><a href="#cb19-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-135"><a href="#cb19-135" aria-hidden="true" tabindex="-1"></a>    DoF <span class="ot">&lt;-</span> trace.term <span class="sc">+</span> q <span class="sc">-</span> tkt <span class="sc">+</span> ykv</span>
<span id="cb19-136"><a href="#cb19-136" aria-hidden="true" tabindex="-1"></a>    DoF <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(DoF <span class="sc">&gt;</span> DoF.max, DoF.max, DoF)</span>
<span id="cb19-137"><a href="#cb19-137" aria-hidden="true" tabindex="-1"></a>    DoF <span class="ot">&lt;-</span> DoF <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb19-138"><a href="#cb19-138" aria-hidden="true" tabindex="-1"></a>    DoF</span>
<span id="cb19-139"><a href="#cb19-139" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-140"><a href="#cb19-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-141"><a href="#cb19-141" aria-hidden="true" tabindex="-1"></a><span class="co"># Pls function manual</span></span>
<span id="cb19-142"><a href="#cb19-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-143"><a href="#cb19-143" aria-hidden="true" tabindex="-1"></a>pls.manual <span class="ot">&lt;-</span> <span class="cf">function</span>(ivs, dv, <span class="at">m =</span> 1L){</span>
<span id="cb19-144"><a href="#cb19-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-145"><a href="#cb19-145" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Parms</span></span>
<span id="cb19-146"><a href="#cb19-146" aria-hidden="true" tabindex="-1"></a>    <span class="co"># M   &lt;- 10 # number of "components"</span></span>
<span id="cb19-147"><a href="#cb19-147" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ivs &lt;- yarn[[1]]</span></span>
<span id="cb19-148"><a href="#cb19-148" aria-hidden="true" tabindex="-1"></a>    <span class="co"># dv &lt;- yarn[[2]]</span></span>
<span id="cb19-149"><a href="#cb19-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-150"><a href="#cb19-150" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scale data</span></span>
<span id="cb19-151"><a href="#cb19-151" aria-hidden="true" tabindex="-1"></a>    M <span class="ot">&lt;-</span> m <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb19-152"><a href="#cb19-152" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(ivs)</span>
<span id="cb19-153"><a href="#cb19-153" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(ivs)</span>
<span id="cb19-154"><a href="#cb19-154" aria-hidden="true" tabindex="-1"></a>    X      <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>M, matrix, <span class="at">nrow =</span> n, <span class="at">ncol =</span> p)</span>
<span id="cb19-155"><a href="#cb19-155" aria-hidden="true" tabindex="-1"></a>    X[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">scale</span>(ivs)</span>
<span id="cb19-156"><a href="#cb19-156" aria-hidden="true" tabindex="-1"></a>    y      <span class="ot">&lt;-</span> dv</span>
<span id="cb19-157"><a href="#cb19-157" aria-hidden="true" tabindex="-1"></a>    y_hat <span class="ot">&lt;-</span> <span class="fu">cbind</span>(</span>
<span id="cb19-158"><a href="#cb19-158" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mean</span>(y),</span>
<span id="cb19-159"><a href="#cb19-159" aria-hidden="true" tabindex="-1"></a>        <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="cn">NA</span>, n <span class="sc">*</span> (M <span class="sc">-</span> <span class="dv">1</span>)), <span class="at">nrow =</span> n)</span>
<span id="cb19-160"><a href="#cb19-160" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-161"><a href="#cb19-161" aria-hidden="true" tabindex="-1"></a>    z         <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> n, <span class="at">ncol =</span> M)</span>
<span id="cb19-162"><a href="#cb19-162" aria-hidden="true" tabindex="-1"></a>    theta_hat <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, M)</span>
<span id="cb19-163"><a href="#cb19-163" aria-hidden="true" tabindex="-1"></a>    W <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> <span class="fu">ncol</span>(ivs), <span class="at">ncol =</span> M)</span>
<span id="cb19-164"><a href="#cb19-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-165"><a href="#cb19-165" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PLS Algorithm following HastieEtAl2017 p 81 (Algorithm 3.3)</span></span>
<span id="cb19-166"><a href="#cb19-166" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (m <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>M) {</span>
<span id="cb19-167"><a href="#cb19-167" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 3a: Compute zm</span></span>
<span id="cb19-168"><a href="#cb19-168" aria-hidden="true" tabindex="-1"></a>        store_2a <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> n, <span class="at">ncol =</span> p)</span>
<span id="cb19-169"><a href="#cb19-169" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p) {</span>
<span id="cb19-170"><a href="#cb19-170" aria-hidden="true" tabindex="-1"></a>            rho_hat_mj <span class="ot">&lt;-</span> <span class="fu">t</span>(X[[m <span class="sc">-</span> <span class="dv">1</span>]][, j]) <span class="sc">%*%</span> y</span>
<span id="cb19-171"><a href="#cb19-171" aria-hidden="true" tabindex="-1"></a>            store_2a[, j] <span class="ot">&lt;-</span> rho_hat_mj <span class="sc">%*%</span> X[[m <span class="sc">-</span> <span class="dv">1</span>]][, j]</span>
<span id="cb19-172"><a href="#cb19-172" aria-hidden="true" tabindex="-1"></a>        }        </span>
<span id="cb19-173"><a href="#cb19-173" aria-hidden="true" tabindex="-1"></a>        z[, m] <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(store_2a)</span>
<span id="cb19-174"><a href="#cb19-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-175"><a href="#cb19-175" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 3b: Compute regression coefficient for y ~ Zm</span></span>
<span id="cb19-176"><a href="#cb19-176" aria-hidden="true" tabindex="-1"></a>        theta_hat[m] <span class="ot">&lt;-</span> <span class="fu">drop</span>(<span class="fu">t</span>(z[, m]) <span class="sc">%*%</span> y <span class="sc">/</span> <span class="fu">t</span>(z[, m]) <span class="sc">%*%</span> z[, m])</span>
<span id="cb19-177"><a href="#cb19-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-178"><a href="#cb19-178" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 3c: Compute predicted y with the current m directions</span></span>
<span id="cb19-179"><a href="#cb19-179" aria-hidden="true" tabindex="-1"></a>        y_hat[, m] <span class="ot">&lt;-</span> y_hat[, m <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">+</span> theta_hat[m] <span class="sc">*</span> z[, m]</span>
<span id="cb19-180"><a href="#cb19-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-181"><a href="#cb19-181" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 3d: Orthogonalize all columns of X with respect to zm</span></span>
<span id="cb19-182"><a href="#cb19-182" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p) {</span>
<span id="cb19-183"><a href="#cb19-183" aria-hidden="true" tabindex="-1"></a>            X[[m]][, j] <span class="ot">&lt;-</span> <span class="fu">orthogonalize</span>(X[[m<span class="dv">-1</span>]][, j], z[, m])</span>
<span id="cb19-184"><a href="#cb19-184" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb19-185"><a href="#cb19-185" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-186"><a href="#cb19-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-187"><a href="#cb19-187" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Normalize the component scores</span></span>
<span id="cb19-188"><a href="#cb19-188" aria-hidden="true" tabindex="-1"></a>    Tsn <span class="ot">&lt;-</span> <span class="fu">apply</span>(z[, <span class="sc">-</span><span class="dv">1</span>], <span class="dv">2</span>, <span class="cf">function</span>(j) j <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(j<span class="sc">^</span><span class="dv">2</span>)))</span>
<span id="cb19-189"><a href="#cb19-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-190"><a href="#cb19-190" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return</span></span>
<span id="cb19-191"><a href="#cb19-191" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(</span>
<span id="cb19-192"><a href="#cb19-192" aria-hidden="true" tabindex="-1"></a>        <span class="fu">list</span>(</span>
<span id="cb19-193"><a href="#cb19-193" aria-hidden="true" tabindex="-1"></a>            <span class="at">Ts =</span> z[, <span class="sc">-</span><span class="dv">1</span>],</span>
<span id="cb19-194"><a href="#cb19-194" aria-hidden="true" tabindex="-1"></a>            <span class="at">Tsn =</span> Tsn,</span>
<span id="cb19-195"><a href="#cb19-195" aria-hidden="true" tabindex="-1"></a>            <span class="at">Yhat =</span> y_hat,</span>
<span id="cb19-196"><a href="#cb19-196" aria-hidden="true" tabindex="-1"></a>            <span class="at">W =</span> W[, <span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb19-197"><a href="#cb19-197" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb19-198"><a href="#cb19-198" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-199"><a href="#cb19-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-200"><a href="#cb19-200" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-201"><a href="#cb19-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-202"><a href="#cb19-202" aria-hidden="true" tabindex="-1"></a><span class="co"># Orthogonalize two vectors</span></span>
<span id="cb19-203"><a href="#cb19-203" aria-hidden="true" tabindex="-1"></a>orthogonalize <span class="ot">&lt;-</span> <span class="cf">function</span>(vec1, vec2) {</span>
<span id="cb19-204"><a href="#cb19-204" aria-hidden="true" tabindex="-1"></a>    v <span class="ot">&lt;-</span> vec1</span>
<span id="cb19-205"><a href="#cb19-205" aria-hidden="true" tabindex="-1"></a>    u <span class="ot">&lt;-</span> vec2</span>
<span id="cb19-206"><a href="#cb19-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-207"><a href="#cb19-207" aria-hidden="true" tabindex="-1"></a>    newv <span class="ot">&lt;-</span> v <span class="sc">-</span> <span class="fu">drop</span>(<span class="fu">t</span>(u) <span class="sc">%*%</span> v <span class="sc">/</span> (<span class="fu">t</span>(u) <span class="sc">%*%</span> u)) <span class="sc">*</span> u</span>
<span id="cb19-208"><a href="#cb19-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-209"><a href="#cb19-209" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(newv)</span>
<span id="cb19-210"><a href="#cb19-210" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-211"><a href="#cb19-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-212"><a href="#cb19-212" aria-hidden="true" tabindex="-1"></a><span class="co"># Load packages ----------------------------------------------------------------</span></span>
<span id="cb19-213"><a href="#cb19-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-214"><a href="#cb19-214" aria-hidden="true" tabindex="-1"></a><span class="co"># load packages</span></span>
<span id="cb19-215"><a href="#cb19-215" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(PCovR)  <span class="co"># for data</span></span>
<span id="cb19-216"><a href="#cb19-216" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pls)    <span class="co"># for pls algorithm</span></span>
<span id="cb19-217"><a href="#cb19-217" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plsdof) <span class="co"># for pls algorithm</span></span>
<span id="cb19-218"><a href="#cb19-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-219"><a href="#cb19-219" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data</span></span>
<span id="cb19-220"><a href="#cb19-220" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(alexithymia)</span>
<span id="cb19-221"><a href="#cb19-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-222"><a href="#cb19-222" aria-hidden="true" tabindex="-1"></a><span class="co"># Devide in X and y</span></span>
<span id="cb19-223"><a href="#cb19-223" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> alexithymia<span class="sc">$</span>X</span>
<span id="cb19-224"><a href="#cb19-224" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> alexithymia<span class="sc">$</span>Y<span class="sc">$</span>RSE</span>
<span id="cb19-225"><a href="#cb19-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-226"><a href="#cb19-226" aria-hidden="true" tabindex="-1"></a><span class="co"># Count the number of variables and observations</span></span>
<span id="cb19-227"><a href="#cb19-227" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X)</span>
<span id="cb19-228"><a href="#cb19-228" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X)</span>
<span id="cb19-229"><a href="#cb19-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-230"><a href="#cb19-230" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the number of directions we will use</span></span>
<span id="cb19-231"><a href="#cb19-231" aria-hidden="true" tabindex="-1"></a>M <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb19-232"><a href="#cb19-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-233"><a href="#cb19-233" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Standardize the data ------------------------------------------------------</span></span>
<span id="cb19-234"><a href="#cb19-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-235"><a href="#cb19-235" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scale the predictors</span></span>
<span id="cb19-236"><a href="#cb19-236" aria-hidden="true" tabindex="-1"></a>    Xstd <span class="ot">&lt;-</span> <span class="fu">scale</span>(X)</span>
<span id="cb19-237"><a href="#cb19-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-238"><a href="#cb19-238" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Means of X are now 0</span></span>
<span id="cb19-239"><a href="#cb19-239" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cbind</span>(</span>
<span id="cb19-240"><a href="#cb19-240" aria-hidden="true" tabindex="-1"></a>        <span class="at">X =</span> <span class="fu">head</span>(<span class="fu">colMeans</span>(X)), </span>
<span id="cb19-241"><a href="#cb19-241" aria-hidden="true" tabindex="-1"></a>        <span class="at">Xstd =</span> <span class="fu">round</span>(<span class="fu">head</span>(<span class="fu">colMeans</span>(Xstd)), <span class="dv">5</span>)</span>
<span id="cb19-242"><a href="#cb19-242" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb19-243"><a href="#cb19-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-244"><a href="#cb19-244" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SD of X are now 1</span></span>
<span id="cb19-245"><a href="#cb19-245" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cbind</span>(</span>
<span id="cb19-246"><a href="#cb19-246" aria-hidden="true" tabindex="-1"></a>        <span class="at">X =</span> <span class="fu">head</span>(<span class="fu">apply</span>(X, <span class="dv">2</span>, sd)),</span>
<span id="cb19-247"><a href="#cb19-247" aria-hidden="true" tabindex="-1"></a>        <span class="at">Xstd =</span> <span class="fu">round</span>(<span class="fu">head</span>(<span class="fu">apply</span>(Xstd, <span class="dv">2</span>, sd)), <span class="dv">5</span>)</span>
<span id="cb19-248"><a href="#cb19-248" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb19-249"><a href="#cb19-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-250"><a href="#cb19-250" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Set initial vlaues --------------------------------------------------------</span></span>
<span id="cb19-251"><a href="#cb19-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-252"><a href="#cb19-252" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2a: Set the initial prediction for y_hat to the mean of y</span></span>
<span id="cb19-253"><a href="#cb19-253" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create an empty data.frame to store the initial value and future predictions</span></span>
<span id="cb19-254"><a href="#cb19-254" aria-hidden="true" tabindex="-1"></a>    yhat_m <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="cn">NA</span>, n <span class="sc">*</span> (M <span class="sc">+</span> <span class="dv">1</span>)), <span class="at">nrow =</span> n)</span>
<span id="cb19-255"><a href="#cb19-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-256"><a href="#cb19-256" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Replace the initial prediction with the mean of y</span></span>
<span id="cb19-257"><a href="#cb19-257" aria-hidden="true" tabindex="-1"></a>    yhat_m[, <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">mean</span>(y)</span>
<span id="cb19-258"><a href="#cb19-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-259"><a href="#cb19-259" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2b: Set every xj0 to xj</span></span>
<span id="cb19-260"><a href="#cb19-260" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create an empty list of X values</span></span>
<span id="cb19-261"><a href="#cb19-261" aria-hidden="true" tabindex="-1"></a>    Xm <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>(M <span class="sc">+</span> <span class="dv">1</span>), matrix, <span class="at">nrow =</span> n, <span class="at">ncol =</span> p)</span>
<span id="cb19-262"><a href="#cb19-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-263"><a href="#cb19-263" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Place X as initial value for Xm</span></span>
<span id="cb19-264"><a href="#cb19-264" aria-hidden="true" tabindex="-1"></a>    Xm[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(Xstd)</span>
<span id="cb19-265"><a href="#cb19-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-266"><a href="#cb19-266" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Estimation ----------------------------------------------------------------</span></span>
<span id="cb19-267"><a href="#cb19-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-268"><a href="#cb19-268" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preparing objects</span></span>
<span id="cb19-269"><a href="#cb19-269" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> n, <span class="at">ncol =</span> (M <span class="sc">+</span> <span class="dv">1</span>)) <span class="co"># container for directions</span></span>
<span id="cb19-270"><a href="#cb19-270" aria-hidden="true" tabindex="-1"></a>    W <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> p, <span class="at">ncol =</span> (M <span class="sc">+</span> <span class="dv">1</span>)) <span class="co"># container for directions</span></span>
<span id="cb19-271"><a href="#cb19-271" aria-hidden="true" tabindex="-1"></a>    theta_hat <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, (M <span class="sc">+</span> <span class="dv">1</span>)) <span class="co"># container for thetas</span></span>
<span id="cb19-272"><a href="#cb19-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-273"><a href="#cb19-273" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PLS Algorithm following HastieEtAl2017 p 81 (Algorithm 3.3)</span></span>
<span id="cb19-274"><a href="#cb19-274" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (m <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>(M <span class="sc">+</span> <span class="dv">1</span>)) {</span>
<span id="cb19-275"><a href="#cb19-275" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 3a: Compute zm</span></span>
<span id="cb19-276"><a href="#cb19-276" aria-hidden="true" tabindex="-1"></a>        W[, m] <span class="ot">&lt;-</span> <span class="fu">t</span>(Xm[[m <span class="sc">-</span> <span class="dv">1</span>]]) <span class="sc">%*%</span> y   <span class="co"># inner products / covariances</span></span>
<span id="cb19-277"><a href="#cb19-277" aria-hidden="true" tabindex="-1"></a>        W <span class="sc">/</span> n</span>
<span id="cb19-278"><a href="#cb19-278" aria-hidden="true" tabindex="-1"></a>        z[, m] <span class="ot">&lt;-</span> Xm[[m <span class="sc">-</span> <span class="dv">1</span>]] <span class="sc">%*%</span> W[, m] <span class="co"># compute the direction zm</span></span>
<span id="cb19-279"><a href="#cb19-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-280"><a href="#cb19-280" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 3b: Compute regression coefficient for y ~ Zm</span></span>
<span id="cb19-281"><a href="#cb19-281" aria-hidden="true" tabindex="-1"></a>        theta_hat[m] <span class="ot">&lt;-</span> <span class="fu">drop</span>(<span class="fu">t</span>(z[, m]) <span class="sc">%*%</span> y <span class="sc">/</span> <span class="fu">t</span>(z[, m]) <span class="sc">%*%</span> z[, m])</span>
<span id="cb19-282"><a href="#cb19-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-283"><a href="#cb19-283" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 3c: Compute predicted y with the current m directions</span></span>
<span id="cb19-284"><a href="#cb19-284" aria-hidden="true" tabindex="-1"></a>        yhat_m[, m] <span class="ot">&lt;-</span> yhat_m[, m <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">+</span> theta_hat[m] <span class="sc">*</span> z[, m]</span>
<span id="cb19-285"><a href="#cb19-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-286"><a href="#cb19-286" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 3d: Orthogonalize all columns of X with respect to zm</span></span>
<span id="cb19-287"><a href="#cb19-287" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p) {</span>
<span id="cb19-288"><a href="#cb19-288" aria-hidden="true" tabindex="-1"></a>            Xm[[m]][, j] <span class="ot">&lt;-</span> <span class="fu">orthogonalize</span>(Xm[[m<span class="dv">-1</span>]][, j], z[, m])</span>
<span id="cb19-289"><a href="#cb19-289" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb19-290"><a href="#cb19-290" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-291"><a href="#cb19-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-292"><a href="#cb19-292" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit PLSR model w/ pls package</span></span>
<span id="cb19-293"><a href="#cb19-293" aria-hidden="true" tabindex="-1"></a>    pls_fit_pls <span class="ot">&lt;-</span> pls<span class="sc">::</span><span class="fu">plsr</span>(</span>
<span id="cb19-294"><a href="#cb19-294" aria-hidden="true" tabindex="-1"></a>        y <span class="sc">~</span> <span class="fu">as.matrix</span>(X),</span>
<span id="cb19-295"><a href="#cb19-295" aria-hidden="true" tabindex="-1"></a>        <span class="at">ncomp =</span> M,</span>
<span id="cb19-296"><a href="#cb19-296" aria-hidden="true" tabindex="-1"></a>        <span class="at">method =</span> <span class="st">"oscorespls"</span>,</span>
<span id="cb19-297"><a href="#cb19-297" aria-hidden="true" tabindex="-1"></a>        <span class="at">validation =</span> <span class="st">"none"</span></span>
<span id="cb19-298"><a href="#cb19-298" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-299"><a href="#cb19-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-300"><a href="#cb19-300" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit PCR model w/ plsdof package</span></span>
<span id="cb19-301"><a href="#cb19-301" aria-hidden="true" tabindex="-1"></a>    pls_fit_plsdof <span class="ot">&lt;-</span> plsdof<span class="sc">::</span><span class="fu">pls.model</span>(<span class="fu">as.matrix</span>(Xstd), y)</span>
<span id="cb19-302"><a href="#cb19-302" aria-hidden="true" tabindex="-1"></a>    pls_fit_plsdof<span class="sc">$</span>coefficients[, <span class="dv">3</span><span class="sc">+</span><span class="dv">1</span>]</span>
<span id="cb19-303"><a href="#cb19-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-304"><a href="#cb19-304" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compare predictions using up to a given m</span></span>
<span id="cb19-305"><a href="#cb19-305" aria-hidden="true" tabindex="-1"></a>    m <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb19-306"><a href="#cb19-306" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(</span>
<span id="cb19-307"><a href="#cb19-307" aria-hidden="true" tabindex="-1"></a>        <span class="fu">data.frame</span>(</span>
<span id="cb19-308"><a href="#cb19-308" aria-hidden="true" tabindex="-1"></a>            <span class="at">pls =</span> <span class="fu">round</span>(<span class="fu">as.data.frame</span>(<span class="fu">fitted</span>(pls_fit_pls)), <span class="dv">3</span>)[, m],</span>
<span id="cb19-309"><a href="#cb19-309" aria-hidden="true" tabindex="-1"></a>            <span class="at">plsdof =</span> <span class="fu">round</span>(pls_fit_plsdof<span class="sc">$</span>Yhat, <span class="dv">3</span>)[, m <span class="sc">+</span> <span class="dv">1</span>],</span>
<span id="cb19-310"><a href="#cb19-310" aria-hidden="true" tabindex="-1"></a>            <span class="at">man =</span> <span class="fu">round</span>(yhat_m, <span class="dv">3</span>)[, m <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb19-311"><a href="#cb19-311" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb19-312"><a href="#cb19-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-313"><a href="#cb19-313" aria-hidden="true" tabindex="-1"></a><span class="co"># Types of DVs -----------------------------------------------------------------</span></span>
<span id="cb19-314"><a href="#cb19-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-315"><a href="#cb19-315" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data</span>(oliveoil)</span>
<span id="cb19-316"><a href="#cb19-316" aria-hidden="true" tabindex="-1"></a>    sens.pcr <span class="ot">&lt;-</span> pls<span class="sc">::</span><span class="fu">pcr</span>(sensory <span class="sc">~</span> chemical, <span class="at">ncomp =</span> <span class="dv">4</span>, <span class="at">scale =</span> <span class="cn">TRUE</span>, <span class="at">data =</span> oliveoil)</span>
<span id="cb19-317"><a href="#cb19-317" aria-hidden="true" tabindex="-1"></a>    sens.pls <span class="ot">&lt;-</span> pls<span class="sc">::</span><span class="fu">plsr</span>(sensory <span class="sc">~</span> chemical, <span class="at">ncomp =</span> <span class="dv">4</span>, <span class="at">scale =</span> <span class="cn">TRUE</span>, <span class="at">data =</span> oliveoil)</span>
<span id="cb19-318"><a href="#cb19-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-319"><a href="#cb19-319" aria-hidden="true" tabindex="-1"></a>    oliveoil<span class="sc">$</span>sensory</span>
<span id="cb19-320"><a href="#cb19-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-321"><a href="#cb19-321" aria-hidden="true" tabindex="-1"></a><span class="co"># Prediction -------------------------------------------------------------------</span></span>
<span id="cb19-322"><a href="#cb19-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-323"><a href="#cb19-323" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="dv">50</span> <span class="co"># number of observations</span></span>
<span id="cb19-324"><a href="#cb19-324" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="dv">15</span> <span class="co"># number of variables</span></span>
<span id="cb19-325"><a href="#cb19-325" aria-hidden="true" tabindex="-1"></a>    X <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n <span class="sc">*</span> p), <span class="at">ncol =</span> p)</span>
<span id="cb19-326"><a href="#cb19-326" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="sc">+</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb19-327"><a href="#cb19-327" aria-hidden="true" tabindex="-1"></a>    M <span class="ot">&lt;-</span> <span class="dv">10</span> <span class="co"># number of "components"</span></span>
<span id="cb19-328"><a href="#cb19-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-329"><a href="#cb19-329" aria-hidden="true" tabindex="-1"></a>    ntest <span class="ot">&lt;-</span> <span class="dv">200</span> <span class="co">#</span></span>
<span id="cb19-330"><a href="#cb19-330" aria-hidden="true" tabindex="-1"></a>    Xtest <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(ntest <span class="sc">*</span> p), <span class="at">ncol =</span> p) <span class="co"># test data</span></span>
<span id="cb19-331"><a href="#cb19-331" aria-hidden="true" tabindex="-1"></a>    ytest <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(ntest) <span class="co"># test data</span></span>
<span id="cb19-332"><a href="#cb19-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-333"><a href="#cb19-333" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit alternative PLSs</span></span>
<span id="cb19-334"><a href="#cb19-334" aria-hidden="true" tabindex="-1"></a>    out_pls <span class="ot">&lt;-</span> pls<span class="sc">::</span><span class="fu">plsr</span>(</span>
<span id="cb19-335"><a href="#cb19-335" aria-hidden="true" tabindex="-1"></a>        y <span class="sc">~</span> X,</span>
<span id="cb19-336"><a href="#cb19-336" aria-hidden="true" tabindex="-1"></a>        <span class="at">ncomp =</span> M,</span>
<span id="cb19-337"><a href="#cb19-337" aria-hidden="true" tabindex="-1"></a>        <span class="at">scale =</span> <span class="cn">TRUE</span>,</span>
<span id="cb19-338"><a href="#cb19-338" aria-hidden="true" tabindex="-1"></a>        <span class="at">center =</span> <span class="cn">TRUE</span>,</span>
<span id="cb19-339"><a href="#cb19-339" aria-hidden="true" tabindex="-1"></a>        <span class="at">method =</span> <span class="st">"oscorespls"</span>,</span>
<span id="cb19-340"><a href="#cb19-340" aria-hidden="true" tabindex="-1"></a>        <span class="at">validation =</span> <span class="st">"none"</span></span>
<span id="cb19-341"><a href="#cb19-341" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-342"><a href="#cb19-342" aria-hidden="true" tabindex="-1"></a>    out_plsdof <span class="ot">&lt;-</span> plsdof<span class="sc">::</span><span class="fu">pls.model</span>(X, y, <span class="at">compute.DoF =</span> <span class="cn">TRUE</span>, <span class="at">Xtest =</span> Xtest, <span class="at">ytest =</span> <span class="cn">NULL</span>)</span>
<span id="cb19-343"><a href="#cb19-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-344"><a href="#cb19-344" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Obtain predictions on new data</span></span>
<span id="cb19-345"><a href="#cb19-345" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(</span>
<span id="cb19-346"><a href="#cb19-346" aria-hidden="true" tabindex="-1"></a>        <span class="fu">round</span>(</span>
<span id="cb19-347"><a href="#cb19-347" aria-hidden="true" tabindex="-1"></a>            <span class="fu">cbind</span>(</span>
<span id="cb19-348"><a href="#cb19-348" aria-hidden="true" tabindex="-1"></a>                <span class="at">PLS =</span> <span class="fu">predict</span>(out_pls, <span class="at">newdata =</span> Xtest)[, , M],</span>
<span id="cb19-349"><a href="#cb19-349" aria-hidden="true" tabindex="-1"></a>                <span class="at">PLSdof =</span> out_plsdof<span class="sc">$</span>prediction[, M <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb19-350"><a href="#cb19-350" aria-hidden="true" tabindex="-1"></a>            ), <span class="dv">5</span></span>
<span id="cb19-351"><a href="#cb19-351" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb19-352"><a href="#cb19-352" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-353"><a href="#cb19-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-354"><a href="#cb19-354" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make sure scale of prediction is correct</span></span>
<span id="cb19-355"><a href="#cb19-355" aria-hidden="true" tabindex="-1"></a>    out_pls_cF <span class="ot">&lt;-</span> <span class="fu">plsr</span>(</span>
<span id="cb19-356"><a href="#cb19-356" aria-hidden="true" tabindex="-1"></a>      y <span class="sc">~</span> X,</span>
<span id="cb19-357"><a href="#cb19-357" aria-hidden="true" tabindex="-1"></a>      <span class="at">ncomp =</span> M,</span>
<span id="cb19-358"><a href="#cb19-358" aria-hidden="true" tabindex="-1"></a>      <span class="at">scale =</span> <span class="cn">TRUE</span>,</span>
<span id="cb19-359"><a href="#cb19-359" aria-hidden="true" tabindex="-1"></a>      <span class="at">center =</span> <span class="cn">FALSE</span>,</span>
<span id="cb19-360"><a href="#cb19-360" aria-hidden="true" tabindex="-1"></a>      <span class="at">method =</span> <span class="st">"oscorespls"</span>,</span>
<span id="cb19-361"><a href="#cb19-361" aria-hidden="true" tabindex="-1"></a>      <span class="at">validation =</span> <span class="st">"none"</span></span>
<span id="cb19-362"><a href="#cb19-362" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-363"><a href="#cb19-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-364"><a href="#cb19-364" aria-hidden="true" tabindex="-1"></a>    Xs <span class="ot">&lt;-</span> <span class="fu">scale</span>(X, <span class="at">center =</span> <span class="cn">TRUE</span>, <span class="at">scale =</span> <span class="cn">FALSE</span>)</span>
<span id="cb19-365"><a href="#cb19-365" aria-hidden="true" tabindex="-1"></a>    ys <span class="ot">&lt;-</span> <span class="fu">scale</span>(y, <span class="at">center =</span> <span class="cn">FALSE</span>, <span class="at">scale =</span> <span class="cn">FALSE</span>)</span>
<span id="cb19-366"><a href="#cb19-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-367"><a href="#cb19-367" aria-hidden="true" tabindex="-1"></a>    out_pls_cF <span class="ot">&lt;-</span> <span class="fu">plsr</span>(</span>
<span id="cb19-368"><a href="#cb19-368" aria-hidden="true" tabindex="-1"></a>      ys <span class="sc">~</span> Xs,</span>
<span id="cb19-369"><a href="#cb19-369" aria-hidden="true" tabindex="-1"></a>      <span class="at">ncomp =</span> M,</span>
<span id="cb19-370"><a href="#cb19-370" aria-hidden="true" tabindex="-1"></a>      <span class="at">scale =</span> <span class="cn">TRUE</span>,</span>
<span id="cb19-371"><a href="#cb19-371" aria-hidden="true" tabindex="-1"></a>      <span class="at">center =</span> <span class="cn">FALSE</span>,</span>
<span id="cb19-372"><a href="#cb19-372" aria-hidden="true" tabindex="-1"></a>      <span class="at">method =</span> <span class="st">"oscorespls"</span>,</span>
<span id="cb19-373"><a href="#cb19-373" aria-hidden="true" tabindex="-1"></a>      <span class="at">validation =</span> <span class="st">"none"</span></span>
<span id="cb19-374"><a href="#cb19-374" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-375"><a href="#cb19-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-376"><a href="#cb19-376" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(</span>
<span id="cb19-377"><a href="#cb19-377" aria-hidden="true" tabindex="-1"></a>        <span class="fu">round</span>(</span>
<span id="cb19-378"><a href="#cb19-378" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cbind</span>(</span>
<span id="cb19-379"><a href="#cb19-379" aria-hidden="true" tabindex="-1"></a>            <span class="at">PLS =</span> <span class="fu">predict</span>(out_pls, <span class="at">newdata =</span> Xtest)[, , M],</span>
<span id="cb19-380"><a href="#cb19-380" aria-hidden="true" tabindex="-1"></a>            <span class="at">PLS_cf =</span> <span class="fu">mean</span>(y) <span class="sc">+</span> <span class="fu">predict</span>(out_pls_cF, <span class="at">newdata =</span> Xtest)[, , M],</span>
<span id="cb19-381"><a href="#cb19-381" aria-hidden="true" tabindex="-1"></a>            <span class="at">PLSdof =</span> out_plsdof<span class="sc">$</span>prediction[, M]</span>
<span id="cb19-382"><a href="#cb19-382" aria-hidden="true" tabindex="-1"></a>        ), <span class="dv">5</span></span>
<span id="cb19-383"><a href="#cb19-383" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb19-384"><a href="#cb19-384" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-385"><a href="#cb19-385" aria-hidden="true" tabindex="-1"></a><span class="co"># PLS degrees of freedom -------------------------------------------------------</span></span>
<span id="cb19-386"><a href="#cb19-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-387"><a href="#cb19-387" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(plsdof)</span>
<span id="cb19-388"><a href="#cb19-388" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb19-389"><a href="#cb19-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-390"><a href="#cb19-390" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate data data</span></span>
<span id="cb19-391"><a href="#cb19-391" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="co"># number of observations</span></span>
<span id="cb19-392"><a href="#cb19-392" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="dv">15</span> <span class="co"># number of variables</span></span>
<span id="cb19-393"><a href="#cb19-393" aria-hidden="true" tabindex="-1"></a>    m <span class="ot">&lt;-</span> <span class="dv">15</span></span>
<span id="cb19-394"><a href="#cb19-394" aria-hidden="true" tabindex="-1"></a>    X <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n <span class="sc">*</span> p), <span class="at">ncol =</span> p)</span>
<span id="cb19-395"><a href="#cb19-395" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb19-396"><a href="#cb19-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-397"><a href="#cb19-397" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit model with package</span></span>
<span id="cb19-398"><a href="#cb19-398" aria-hidden="true" tabindex="-1"></a>    outpls <span class="ot">&lt;-</span> <span class="fu">pls.model</span>(X, y, <span class="at">compute.DoF =</span> <span class="cn">TRUE</span>)</span>
<span id="cb19-399"><a href="#cb19-399" aria-hidden="true" tabindex="-1"></a>    outpls<span class="sc">$</span>DoF</span>
<span id="cb19-400"><a href="#cb19-400" aria-hidden="true" tabindex="-1"></a>    outpls.internal <span class="ot">&lt;-</span> <span class="fu">linear.pls.fit</span>(X, y, m, <span class="at">DoF.max =</span> <span class="fu">min</span>(n <span class="sc">-</span> <span class="dv">1</span>, p <span class="sc">+</span> <span class="dv">1</span>))</span>
<span id="cb19-401"><a href="#cb19-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-402"><a href="#cb19-402" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit model with person PLS function</span></span>
<span id="cb19-403"><a href="#cb19-403" aria-hidden="true" tabindex="-1"></a>    outpls_man <span class="ot">&lt;-</span> <span class="fu">pls.manual</span>(<span class="at">ivs =</span> X, <span class="at">dv =</span> y, <span class="at">m =</span> m)</span>
<span id="cb19-404"><a href="#cb19-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-405"><a href="#cb19-405" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit model with plsr function from pls</span></span>
<span id="cb19-406"><a href="#cb19-406" aria-hidden="true" tabindex="-1"></a>    pls_fit_pls <span class="ot">&lt;-</span> <span class="fu">plsr</span>(</span>
<span id="cb19-407"><a href="#cb19-407" aria-hidden="true" tabindex="-1"></a>        y <span class="sc">~</span> X,</span>
<span id="cb19-408"><a href="#cb19-408" aria-hidden="true" tabindex="-1"></a>        <span class="at">ncomp =</span> m,</span>
<span id="cb19-409"><a href="#cb19-409" aria-hidden="true" tabindex="-1"></a>        <span class="at">scale =</span> <span class="cn">FALSE</span>,</span>
<span id="cb19-410"><a href="#cb19-410" aria-hidden="true" tabindex="-1"></a>        <span class="at">center =</span> <span class="cn">FALSE</span>,</span>
<span id="cb19-411"><a href="#cb19-411" aria-hidden="true" tabindex="-1"></a>        <span class="at">method =</span> <span class="st">"oscorespls"</span>,</span>
<span id="cb19-412"><a href="#cb19-412" aria-hidden="true" tabindex="-1"></a>        <span class="at">validation =</span> <span class="st">"none"</span></span>
<span id="cb19-413"><a href="#cb19-413" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-414"><a href="#cb19-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-415"><a href="#cb19-415" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Y hats</span></span>
<span id="cb19-416"><a href="#cb19-416" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(outpls_man<span class="sc">$</span>Yhat <span class="sc">-</span> outpls<span class="sc">$</span>Yhat, <span class="dv">5</span>)</span>
<span id="cb19-417"><a href="#cb19-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-418"><a href="#cb19-418" aria-hidden="true" tabindex="-1"></a>    <span class="co"># T scores</span></span>
<span id="cb19-419"><a href="#cb19-419" aria-hidden="true" tabindex="-1"></a>    j <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb19-420"><a href="#cb19-420" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cbind</span>(</span>
<span id="cb19-421"><a href="#cb19-421" aria-hidden="true" tabindex="-1"></a>        <span class="at">PLSR =</span> <span class="fu">apply</span>(<span class="fu">scores</span>(pls_fit_pls), <span class="dv">2</span>, <span class="cf">function</span>(j) j <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(j<span class="sc">^</span><span class="dv">2</span>)))[, j],</span>
<span id="cb19-422"><a href="#cb19-422" aria-hidden="true" tabindex="-1"></a>        <span class="at">PLSTT =</span> outpls.internal<span class="sc">$</span>TT[, j],</span>
<span id="cb19-423"><a href="#cb19-423" aria-hidden="true" tabindex="-1"></a>        <span class="at">manualTs =</span> outpls_man<span class="sc">$</span>Ts[, j],</span>
<span id="cb19-424"><a href="#cb19-424" aria-hidden="true" tabindex="-1"></a>        <span class="at">manualTsn =</span> outpls_man<span class="sc">$</span>Tsn[, j]</span>
<span id="cb19-425"><a href="#cb19-425" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-426"><a href="#cb19-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-427"><a href="#cb19-427" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Degrees of freedom PLSR</span></span>
<span id="cb19-428"><a href="#cb19-428" aria-hidden="true" tabindex="-1"></a>    predi <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span>m, <span class="cf">function</span>(j) {</span>
<span id="cb19-429"><a href="#cb19-429" aria-hidden="true" tabindex="-1"></a>        <span class="fu">predict</span>(pls_fit_pls, <span class="at">ncomp =</span> j)</span>
<span id="cb19-430"><a href="#cb19-430" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb19-431"><a href="#cb19-431" aria-hidden="true" tabindex="-1"></a>    DoF_plsr <span class="ot">&lt;-</span> <span class="fu">dofPLS</span>(</span>
<span id="cb19-432"><a href="#cb19-432" aria-hidden="true" tabindex="-1"></a>        X,</span>
<span id="cb19-433"><a href="#cb19-433" aria-hidden="true" tabindex="-1"></a>        y,</span>
<span id="cb19-434"><a href="#cb19-434" aria-hidden="true" tabindex="-1"></a>        <span class="at">TT =</span> <span class="fu">apply</span>(<span class="fu">scores</span>(pls_fit_pls), <span class="dv">2</span>, <span class="cf">function</span>(j) j <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(j<span class="sc">^</span><span class="dv">2</span>))),</span>
<span id="cb19-435"><a href="#cb19-435" aria-hidden="true" tabindex="-1"></a>        <span class="at">Yhat =</span> predi,</span>
<span id="cb19-436"><a href="#cb19-436" aria-hidden="true" tabindex="-1"></a>        <span class="at">DoF.max =</span> m <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb19-437"><a href="#cb19-437" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-438"><a href="#cb19-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-439"><a href="#cb19-439" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Degrees of freedom manual</span></span>
<span id="cb19-440"><a href="#cb19-440" aria-hidden="true" tabindex="-1"></a>    DoF_manual <span class="ot">&lt;-</span> <span class="fu">dofPLS</span>(</span>
<span id="cb19-441"><a href="#cb19-441" aria-hidden="true" tabindex="-1"></a>        X,</span>
<span id="cb19-442"><a href="#cb19-442" aria-hidden="true" tabindex="-1"></a>        y,</span>
<span id="cb19-443"><a href="#cb19-443" aria-hidden="true" tabindex="-1"></a>        <span class="at">TT =</span> outpls_man<span class="sc">$</span>Tsn,</span>
<span id="cb19-444"><a href="#cb19-444" aria-hidden="true" tabindex="-1"></a>        <span class="at">Yhat =</span> outpls_man<span class="sc">$</span>Yhat[, <span class="dv">2</span><span class="sc">:</span>(m <span class="sc">+</span> <span class="dv">1</span>)],</span>
<span id="cb19-445"><a href="#cb19-445" aria-hidden="true" tabindex="-1"></a>        <span class="at">DoF.max =</span> m <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb19-446"><a href="#cb19-446" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-447"><a href="#cb19-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-448"><a href="#cb19-448" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Single DoF</span></span>
<span id="cb19-449"><a href="#cb19-449" aria-hidden="true" tabindex="-1"></a>    DoF_single <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span>m, <span class="cf">function</span>(i) {</span>
<span id="cb19-450"><a href="#cb19-450" aria-hidden="true" tabindex="-1"></a>        <span class="fu">dofPLS_single</span>(</span>
<span id="cb19-451"><a href="#cb19-451" aria-hidden="true" tabindex="-1"></a>            X,</span>
<span id="cb19-452"><a href="#cb19-452" aria-hidden="true" tabindex="-1"></a>            y,</span>
<span id="cb19-453"><a href="#cb19-453" aria-hidden="true" tabindex="-1"></a>            <span class="at">TT =</span> outpls_man<span class="sc">$</span>Tsn,</span>
<span id="cb19-454"><a href="#cb19-454" aria-hidden="true" tabindex="-1"></a>            <span class="at">Yhat =</span> outpls_man<span class="sc">$</span>Yhat[, (i <span class="sc">+</span> <span class="dv">1</span>)],</span>
<span id="cb19-455"><a href="#cb19-455" aria-hidden="true" tabindex="-1"></a>            <span class="at">q =</span> i</span>
<span id="cb19-456"><a href="#cb19-456" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb19-457"><a href="#cb19-457" aria-hidden="true" tabindex="-1"></a>    }))</span>
<span id="cb19-458"><a href="#cb19-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-459"><a href="#cb19-459" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compare degrees of freedom</span></span>
<span id="cb19-460"><a href="#cb19-460" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cbind</span>(</span>
<span id="cb19-461"><a href="#cb19-461" aria-hidden="true" tabindex="-1"></a>        <span class="at">PLSR =</span> DoF_plsr,</span>
<span id="cb19-462"><a href="#cb19-462" aria-hidden="true" tabindex="-1"></a>        <span class="at">PLSdof =</span> outpls<span class="sc">$</span>DoF,</span>
<span id="cb19-463"><a href="#cb19-463" aria-hidden="true" tabindex="-1"></a>        <span class="at">PLS_manual =</span> DoF_manual,</span>
<span id="cb19-464"><a href="#cb19-464" aria-hidden="true" tabindex="-1"></a>        <span class="at">diff =</span> <span class="fu">round</span>(outpls<span class="sc">$</span>DoF <span class="sc">-</span> DoF_manual, <span class="dv">5</span>),</span>
<span id="cb19-465"><a href="#cb19-465" aria-hidden="true" tabindex="-1"></a>        <span class="at">DoF_single =</span> DoF_single</span>
<span id="cb19-466"><a href="#cb19-466" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="references" class="level1">




</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-hastieEtAl:2015" class="csl-entry" role="doc-biblioentry">
Hastie, Trevor, Robert Tibshirani, and Martin Wainwright. 2015. <em>Statistical Learning with Sparsity: The Lasso and Generalizations</em>. CRC press.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Check the helpfile for the <code>alexithymia</code> data in the <code>PCovR</code> package for more information.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } 
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>