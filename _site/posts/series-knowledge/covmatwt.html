<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Edoardo Costantini">
<meta name="dcterms.date" content="2022-03-14">

<title>Edo - Estimating the weighted covariance matrix in R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Edo</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-digital-garden" role="button" data-bs-toggle="dropdown" aria-expanded="false">Digital garden</a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-digital-garden">    
        <li>
    <a class="dropdown-item" href="../../all-posts.html">
 <span class="dropdown-text">All posts</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../series-pca.html">
 <span class="dropdown-text">A primer on PCA</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../series-sm-course.html">
 <span class="dropdown-text">Course: Statistics and Methodology</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../series-sampling.html">
 <span class="dropdown-text">Sampling</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../research.html">Research</a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Estimating the weighted covariance matrix in R</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">Statistics</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Edoardo Costantini </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">March 14, 2022</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#learn-by-coding" id="toc-learn-by-coding" class="nav-link" data-scroll-target="#learn-by-coding">Learn by coding</a>
  <ul class="collapse">
  <li><a href="#example" id="toc-example" class="nav-link" data-scroll-target="#example">Example</a></li>
  <li><a href="#computing-the-weighted-covariance-matrix-manually" id="toc-computing-the-weighted-covariance-matrix-manually" class="nav-link" data-scroll-target="#computing-the-weighted-covariance-matrix-manually">Computing the weighted covariance matrix manually</a>
  <ul class="collapse">
  <li><a href="#exploring-the-statscov.wt-function-code" id="toc-exploring-the-statscov.wt-function-code" class="nav-link" data-scroll-target="#exploring-the-statscov.wt-function-code">Exploring the <code>stats::cov.wt()</code> function code</a></li>
  <li><a href="#reproducing-the-internal-steps" id="toc-reproducing-the-internal-steps" class="nav-link" data-scroll-target="#reproducing-the-internal-steps">Reproducing the internal steps</a></li>
  </ul></li>
  <li><a href="#mathematical-formula-and-alternative-r-computations" id="toc-mathematical-formula-and-alternative-r-computations" class="nav-link" data-scroll-target="#mathematical-formula-and-alternative-r-computations">Mathematical formula and alternative R computations</a>
  <ul class="collapse">
  <li><a href="#unbiased-weighted-covariance-matrix" id="toc-unbiased-weighted-covariance-matrix" class="nav-link" data-scroll-target="#unbiased-weighted-covariance-matrix">Unbiased weighted covariance matrix</a></li>
  <li><a href="#maximum-likelihood-weighted-covariance-matrix" id="toc-maximum-likelihood-weighted-covariance-matrix" class="nav-link" data-scroll-target="#maximum-likelihood-weighted-covariance-matrix">Maximum Likelihood weighted covariance matrix</a></li>
  </ul></li>
  <li><a href="#relationship-with-the-matrix-of-sufficient-statistics" id="toc-relationship-with-the-matrix-of-sufficient-statistics" class="nav-link" data-scroll-target="#relationship-with-the-matrix-of-sufficient-statistics">Relationship with the matrix of sufficient statistics</a></li>
  </ul></li>
  <li><a href="#tldr-just-give-me-the-code" id="toc-tldr-just-give-me-the-code" class="nav-link" data-scroll-target="#tldr-just-give-me-the-code">TL;DR, just give me the code!</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>In a sample made of groups of different sizes, descriptive statistics like the mean and the covariance between variables can be computed by assigning proper weights to account for the difference in group sizes. Wights are generally normalized (i.e., <span class="math inline">\(\sum_{i = 1}^{n} w_i = 1\)</span>).</p>
</section>
<section id="learn-by-coding" class="level1">
<h1>Learn by coding</h1>
<section id="example" class="level2">
<h2 class="anchored" data-anchor-id="example">Example</h2>
<p>Now, let’s consider a very simple example. Say that you have a dataset with two variables and that you have a vector of weights defining how important each observation should be.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial simple example -------------------------------------------------------</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the dataset used in the example of stats::cov.wt()</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  xy <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">8</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">8</span><span class="sc">:</span><span class="dv">10</span>))</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define non-negative weights (as in example of stats::cov.wt())</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  wi <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the weighted estimate with the default methods</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  covwt_stats <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">cov.wt</span>(xy, <span class="at">wt =</span> wi) <span class="co"># i.e. method = "unbiased"</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compare unweighted and weighted means</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">uw =</span> <span class="fu">colMeans</span>(xy),</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>             <span class="at">select =</span> <span class="fu">colMeans</span>(xy[wi <span class="sc">==</span> <span class="dv">1</span>, ]),</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>             <span class="at">wg =</span> covwt_stats<span class="sc">$</span>center)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   uw select  wg
x 5.5    6.0 6.0
y 5.9    6.8 6.8</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compare unweighted and weighted covariance matrix</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">uw =</span> <span class="fu">c</span>(<span class="fu">cov</span>(xy)),</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">select =</span> <span class="fu">c</span>(<span class="fu">cov</span>(xy[wi <span class="sc">==</span> <span class="dv">1</span>, ])),</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">wg =</span> <span class="fu">c</span>(covwt_stats<span class="sc">$</span>cov),</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">row.names =</span> <span class="fu">c</span>(<span class="fu">sapply</span>(<span class="fu">colnames</span>(<span class="fu">cov</span>(xy)), paste0, <span class="fu">rownames</span>(<span class="fu">cov</span>(xy))))</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         uw select   wg
xx 9.166667    2.5  2.5
xy 8.055556   -0.5 -0.5
yx 8.055556   -0.5 -0.5
yy 9.433333    1.7  1.7</code></pre>
</div>
</div>
<p>Note how by weighting with a vector of 0 and 1s we are basically saying that the observations with a 0 will be excluded from the count. They are weighted to have 0 impact on the computation of the descriptive statistics. This is clear when you compare the results of the <code>select</code> and <code>wg</code> columns.</p>
</section>
<section id="computing-the-weighted-covariance-matrix-manually" class="level2">
<h2 class="anchored" data-anchor-id="computing-the-weighted-covariance-matrix-manually">Computing the weighted covariance matrix manually</h2>
<p>We could replicate the results of the weighting simply by selecting a subset of the original data because all observations were either weighted 0 or equally (1). When this is not the case, weighting is slightly more complicated.</p>
<section id="exploring-the-statscov.wt-function-code" class="level3">
<h3 class="anchored" data-anchor-id="exploring-the-statscov.wt-function-code">Exploring the <code>stats::cov.wt()</code> function code</h3>
<p>Let’s look at how the <code>cov.wt()</code> function works more in depth. The internal code of the function is the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Examine the internal code of stats::cov.wt() ---------------------------------</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  cov.wt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function (x, wt = rep(1/nrow(x), nrow(x)), cor = FALSE, center = TRUE, 
    method = c("unbiased", "ML")) 
{
    if (is.data.frame(x)) 
        x &lt;- as.matrix(x)
    else if (!is.matrix(x)) 
        stop("'x' must be a matrix or a data frame")
    if (!all(is.finite(x))) 
        stop("'x' must contain finite values only")
    n &lt;- nrow(x)
    if (with.wt &lt;- !missing(wt)) {
        if (length(wt) != n) 
            stop("length of 'wt' must equal the number of rows in 'x'")
        if (any(wt &lt; 0) || (s &lt;- sum(wt)) == 0) 
            stop("weights must be non-negative and not all zero")
        wt &lt;- wt/s
    }
    if (is.logical(center)) {
        center &lt;- if (center) 
            colSums(wt * x)
        else 0
    }
    else {
        if (length(center) != ncol(x)) 
            stop("length of 'center' must equal the number of columns in 'x'")
    }
    x &lt;- sqrt(wt) * sweep(x, 2, center, check.margin = FALSE)
    cov &lt;- switch(match.arg(method), unbiased = crossprod(x)/(1 - 
        sum(wt^2)), ML = crossprod(x))
    y &lt;- list(cov = cov, center = center, n.obs = n)
    if (with.wt) 
        y$wt &lt;- wt
    if (cor) {
        Is &lt;- 1/sqrt(diag(cov))
        R &lt;- cov
        R[] &lt;- Is * cov * rep(Is, each = nrow(cov))
        y$cor &lt;- R
    }
    y
}
&lt;bytecode: 0x7f9aad24e868&gt;
&lt;environment: namespace:stats&gt;</code></pre>
</div>
</div>
<p>Note the following:</p>
<ul>
<li><p>The first thing to pay attention to is that the function can <strong>compute</strong> the weighted covariance matrix <strong>in two ways</strong>:</p>
<ul>
<li>unbiased, using <code>corssprod(x) / (1 - sum(wt^2))</code></li>
<li>ML (or maximum likelihood), using <code>corssprod(x)</code></li>
</ul></li>
<li><p>Note that the <code>wt</code> object is divided by the sum of the values it is storing, which amounts to <strong>normalising</strong> the weights. This happens with <code>wt &lt;- wt/s</code> with <code>s</code> being created inside an if statement as <code>s &lt;- sum(wt)</code>.</p></li>
<li><p><code>x</code> is <strong>centered</strong> on the normalized weigthed means using the <code>sweep</code> function</p></li>
<li><p><code>x</code> is <strong>weighted</strong> by multiplying by <code>sqrt(wt)</code></p></li>
</ul>
</section>
<section id="reproducing-the-internal-steps" class="level3">
<h3 class="anchored" data-anchor-id="reproducing-the-internal-steps">Reproducing the internal steps</h3>
<p>First, we’ll <strong>set up</strong> a few objects we need to replicate manually what happens inside the <code>stats::cov.wt()</code> function. We need to define a dataset, a vector of weights, a method to compute descriptives, and based on these we will also create an object to store the number of rows (<code>n</code>). As a vector of weights we sample random values between 0 and 1. We can think of this as an attempt to weight each observation for the probability of sampling them from a population.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up manual computation of cov.wt() ----------------------------------------</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Assign values to the function arguments</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  x      <span class="ot">&lt;-</span> xy                     <span class="co"># data</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">20220314</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  wi     <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="fu">length</span>(wi), <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  method <span class="ot">&lt;-</span> <span class="st">"ML"</span>                   <span class="co"># use Maximum Likelihood for estimation</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Assign values to some of the internal objects</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we want to make sure we <strong>normalize the weights</strong>. In other words we want to make sure the weights sum to 1.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize weights ------------------------------------------------------------</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Normalise weights (to sum to 1)</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  wn <span class="ot">&lt;-</span> wi <span class="sc">/</span> <span class="fu">sum</span>(wi)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check they sum to 1</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(wn) <span class="sc">==</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>Then, we want to compute the <strong>vector of <a href="https://en.wikipedia.org/wiki/Weighted_arithmetic_mean#:~:text=Mathematical%20definition%5Bedit%5D">weighted means</a></strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the weighted means ---------------------------------------------------</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Center on weighted mean if required</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  center <span class="ot">&lt;-</span> <span class="fu">colSums</span>(wn <span class="sc">*</span> x)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Center X on the weigthed mean</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  x_cent <span class="ot">&lt;-</span> <span class="fu">sweep</span>(x, <span class="dv">2</span>, center, <span class="at">check.margin =</span> <span class="cn">FALSE</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Note that the sweep is subtracting the "center" to each value</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">all.equal</span>(</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sweep</span>(x, <span class="dv">2</span>, center, <span class="at">check.margin =</span> <span class="cn">FALSE</span>),</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">t</span>(<span class="fu">apply</span>(x, <span class="dv">1</span>, <span class="cf">function</span> (i) i <span class="sc">-</span> center))</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>Note that the weighted mean is computed as: [ {x} = _{i = 1}^{n} w_i x_i ] and that <code>center &lt;- colSums(wn * x)</code> is doing exactly this.</p>
<p>Finally, we want to compute the <strong><a href="https://en.wikipedia.org/wiki/Sample_mean_and_covariance#:~:text=weighted%20covariance%20matrix">weighted covariance matrix</a></strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the weighted covariance matrix ---------------------------------------</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Weight (centered) data</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  x_weighted <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(wn) <span class="sc">*</span> x_cent</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the ML weigthed covariance matrix manually</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  covwt_man <span class="ot">&lt;-</span> <span class="fu">crossprod</span>(x_weighted)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print the manual weigthed covariance matrix</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  covwt_man</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         x        y
x 7.102015 5.431419
y 5.431419 6.210209</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the ML weigthed covariance matrix with stats::cov.wt()</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  covwt_stats <span class="ot">&lt;-</span> <span class="fu">cov.wt</span>(xy, <span class="at">wt =</span> wi, <span class="at">method =</span> <span class="st">"ML"</span>, <span class="at">center =</span> <span class="cn">TRUE</span>)<span class="sc">$</span>cov</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compare manual and stats weigthed covariance matrices</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  covwt_man <span class="sc">-</span> covwt_stats</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  x y
x 0 0
y 0 0</code></pre>
</div>
</div>
</section>
</section>
<section id="mathematical-formula-and-alternative-r-computations" class="level2">
<h2 class="anchored" data-anchor-id="mathematical-formula-and-alternative-r-computations">Mathematical formula and alternative R computations</h2>
<section id="unbiased-weighted-covariance-matrix" class="level3">
<h3 class="anchored" data-anchor-id="unbiased-weighted-covariance-matrix">Unbiased weighted covariance matrix</h3>
<p>For a given population covariance matrix <span class="math inline">\(Q\)</span>, each element <span class="math inline">\(q_{ik}\)</span> of the <strong>unbiased</strong> estimation of the weighted covariance matrix <span class="math inline">\(\hat{Q}\)</span> can be computed with the following formula:</p>
<p>[ q_{ik} = <em>{i = 1}^{n} w_i (x</em>{ij} - {x}<em>j) (x</em>{ij} - {x}_k) ]</p>
<p>with <span class="math inline">\(\bar{x}_j\)</span> being the weighted mean for variable <span class="math inline">\(j\)</span>, and <span class="math inline">\(w_i\)</span> being the normalized weight for a given observation (which we store in the vector <code>wn</code>). The following are alternative ways of computing it with mathematical or R shortcuts:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternative computations of the unbiased weighted covariance mat -------------</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Literal translation of equation</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">sum</span>(wn<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">*</span> <span class="fu">t</span>(wn <span class="sc">*</span> x_cent) <span class="sc">%*%</span> (x_cent)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         x        y
x 8.320767 6.363485
y 6.363485 7.275922</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rearrange denominator</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">t</span>(wn <span class="sc">*</span> x_cent) <span class="sc">%*%</span> (x_cent) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">sum</span>(wn<span class="sc">^</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         x        y
x 8.320767 6.363485
y 6.363485 7.275922</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Spread wn</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">t</span>(<span class="fu">sqrt</span>(wn) <span class="sc">*</span> x_cent) <span class="sc">%*%</span> (<span class="fu">sqrt</span>(wn)<span class="sc">*</span>x_cent) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">sum</span>(wn<span class="sc">^</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         x        y
x 8.320767 6.363485
y 6.363485 7.275922</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Replace manual cross-product with R cross-product</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">crossprod</span>(<span class="fu">sqrt</span>(wn) <span class="sc">*</span> x_cent)<span class="sc">/</span>(<span class="dv">1</span> <span class="sc">-</span> <span class="fu">sum</span>(wn<span class="sc">^</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         x        y
x 8.320767 6.363485
y 6.363485 7.275922</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute with stats::cov.wt()</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cov.wt</span>(xy, <span class="at">wt =</span> wi, <span class="at">method =</span> <span class="st">"unbiased"</span>, <span class="at">center =</span> <span class="cn">TRUE</span>)<span class="sc">$</span>cov</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         x        y
x 8.320767 6.363485
y 6.363485 7.275922</code></pre>
</div>
</div>
</section>
<section id="maximum-likelihood-weighted-covariance-matrix" class="level3">
<h3 class="anchored" data-anchor-id="maximum-likelihood-weighted-covariance-matrix">Maximum Likelihood weighted covariance matrix</h3>
<p>Each element <span class="math inline">\(q_{ik}\)</span> of the <strong>maximum likelihood</strong> weighted covariance matrix estimate <span class="math inline">\(\hat{Q}\)</span> can be computed manually with the following formula:</p>
<p>[ q_{ik} = <em>{i = 1}^{n} w_i (x</em>{ij} - {x}<em>j) (x</em>{ij} - {x}_k) ]</p>
<p>with <span class="math inline">\(\bar{x}_j\)</span> being the weighted mean for variable <span class="math inline">\(j\)</span>, and <span class="math inline">\(w_i\)</span> being the normalized weight for a given observation. The following are alternative ways of computing it with mathematical or R shortcuts:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternative computations of the ML weighted covariance mat -------------------</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># R manual cross-product using un-normalised weights</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sum</span>(wi) <span class="sc">*</span> <span class="fu">t</span>(wi <span class="sc">*</span> x_cent) <span class="sc">%*%</span> (x_cent)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         x        y
x 7.102015 5.431419
y 5.431419 6.210209</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Using the normalised weights</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sum</span>(wn) <span class="sc">*</span> <span class="fu">t</span>(wn <span class="sc">*</span> x_cent) <span class="sc">%*%</span> (x_cent)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         x        y
x 7.102015 5.431419
y 5.431419 6.210209</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Dropp the term = 1</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">t</span>(wn <span class="sc">*</span> x_cent) <span class="sc">%*%</span> (x_cent)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         x        y
x 7.102015 5.431419
y 5.431419 6.210209</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Spread wn</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">t</span>(<span class="fu">sqrt</span>(wn) <span class="sc">*</span> x_cent) <span class="sc">%*%</span> (<span class="fu">sqrt</span>(wn) <span class="sc">*</span> x_cent)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         x        y
x 7.102015 5.431419
y 5.431419 6.210209</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Replace manual cross-product with R cross-product</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">crossprod</span>(<span class="fu">sqrt</span>(wn) <span class="sc">*</span> x_cent)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         x        y
x 7.102015 5.431419
y 5.431419 6.210209</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># R cross-product matrix</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">crossprod</span>(x_weighted)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         x        y
x 7.102015 5.431419
y 5.431419 6.210209</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute with stats::cov.wt()</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cov.wt</span>(xy, <span class="at">wt =</span> wi, <span class="at">method =</span> <span class="st">"ML"</span>, <span class="at">center =</span> <span class="cn">TRUE</span>)<span class="sc">$</span>cov</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         x        y
x 7.102015 5.431419
y 5.431419 6.210209</code></pre>
</div>
</div>
</section>
</section>
<section id="relationship-with-the-matrix-of-sufficient-statistics" class="level2">
<h2 class="anchored" data-anchor-id="relationship-with-the-matrix-of-sufficient-statistics">Relationship with the matrix of sufficient statistics</h2>
<p>Note the relationship between the covariance matrix and the matrix of sufficient statistics is the same as in the <em>unweighted</em> case: <span class="math inline">\(\text{cov} = \frac{T_{\text{obs}}}{n}\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtain the matrix of sufficient statistics Tobs ------------------------------</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define a new weigthing object</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">20220314</span>)</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  wi <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="fu">length</span>(wi), <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>)</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  wn <span class="ot">&lt;-</span> wi <span class="sc">/</span> <span class="fu">sum</span>(wi)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the weighted means of X again</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>  center <span class="ot">&lt;-</span> <span class="fu">colSums</span>(wn <span class="sc">*</span> x)</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>  x_cent <span class="ot">&lt;-</span> <span class="fu">sweep</span>(x, <span class="dv">2</span>, center, <span class="at">check.margin =</span> <span class="cn">FALSE</span>)</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># "Effective" sample size</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">sum</span>(wi)</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Number of columns</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(x)</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtain matrix of sufficient statistics (Tobs)</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>  Tobs_lopp <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, p, p)</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(x)){</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>    Tobs_lopp <span class="ot">&lt;-</span> Tobs_lopp <span class="sc">+</span> wi[i] <span class="sc">*</span> (x_cent[i, ]) <span class="sc">%*%</span> <span class="fu">t</span>(x_cent[i, ])</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtain matrix of sufficient statistics (Tobs) w/ cross-product shortcut</span></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>  Tobs_cp <span class="ot">&lt;-</span> <span class="fu">t</span>(wi <span class="sc">*</span> x_cent) <span class="sc">%*%</span> x_cent</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compare loop version and cross-product shortcut</span></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>  Tobs_lopp <span class="sc">-</span> Tobs_cp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     x            y
[1,] 0 3.552714e-15
[2,] 0 0.000000e+00</code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Assign simpler name and print Tobs</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  (Tobs <span class="ot">&lt;-</span> Tobs_cp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         x        y
x 31.08417 23.77229
y 23.77229 27.18091</code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert to a covariance matrix</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  covmat <span class="ot">&lt;-</span> Tobs <span class="sc">/</span> n</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check it's what you were expecting</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  covmat <span class="sc">-</span> <span class="fu">cov.wt</span>(xy, <span class="at">wt =</span> wi, <span class="at">method =</span> <span class="st">"ML"</span>, <span class="at">center =</span> <span class="cn">TRUE</span>)<span class="sc">$</span>cov</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  x             y
x 0 -8.881784e-16
y 0 -8.881784e-16</code></pre>
</div>
</div>
<p>Note the following:</p>
<ul>
<li>we are using the normalized weights <code>wn</code> to center the data, but we are using the un-normalised weights to scale the data contribution to <code>Tobs</code></li>
<li>if we had used the normalized weights, <span class="math inline">\(n\)</span> would have been equal to 1 and <code>covmat</code> would be equal to <code>Tobs</code>.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtain the matrix of sufficient statistics Tobs (normalised weights) ---------</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert to a covariance matrix</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  covmat <span class="sc">-</span> <span class="fu">t</span>(wn <span class="sc">*</span> x_cent) <span class="sc">%*%</span> x_cent</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             x y
x 0.000000e+00 0
y 8.881784e-16 0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Then, covmat relates to Tobs as</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  (<span class="fu">t</span>(wn <span class="sc">*</span> x_cent) <span class="sc">%*%</span> x_cent <span class="sc">*</span> n) <span class="sc">-</span> Tobs_cp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              x y
x  0.000000e+00 0
y -3.552714e-15 0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># So we could say</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  Tobs <span class="ot">&lt;-</span> <span class="fu">t</span>(wn <span class="sc">*</span> x_cent) <span class="sc">%*%</span> x_cent <span class="sc">*</span> n</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="tldr-just-give-me-the-code" class="level1">
<h1>TL;DR, just give me the code!</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial simple example -------------------------------------------------------</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the dataset used in the example of stats::cov.wt()</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  xy <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">8</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">8</span><span class="sc">:</span><span class="dv">10</span>))</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define non-negative weights (as in example of stats::cov.wt())</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>  wi <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>)</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the weighted estimate with the default methods</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>  covwt_stats <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">cov.wt</span>(xy, <span class="at">wt =</span> wi) <span class="co"># i.e. method = "unbiased"</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compare unweighted and weighted means</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">uw =</span> <span class="fu">colMeans</span>(xy),</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>             <span class="at">select =</span> <span class="fu">colMeans</span>(xy[wi <span class="sc">==</span> <span class="dv">1</span>, ]),</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>             <span class="at">wg =</span> covwt_stats<span class="sc">$</span>center)</span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compare unweighted and weighted covariance matrix</span></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">uw =</span> <span class="fu">c</span>(<span class="fu">cov</span>(xy)),</span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>             <span class="at">select =</span> <span class="fu">c</span>(<span class="fu">cov</span>(xy[wi <span class="sc">==</span> <span class="dv">1</span>, ])),</span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>             <span class="at">wg =</span> <span class="fu">c</span>(covwt_stats<span class="sc">$</span>cov),</span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>             <span class="at">row.names =</span> <span class="fu">c</span>(<span class="fu">sapply</span>(<span class="fu">colnames</span>(<span class="fu">cov</span>(xy)), paste0, <span class="fu">rownames</span>(<span class="fu">cov</span>(xy))))</span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Examine the internal code of stats::cov.wt() ---------------------------------</span></span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>  cov.wt</span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up manual computation of cov.wt() ----------------------------------------</span></span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Assign values to the function arguments</span></span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a>  x      <span class="ot">&lt;-</span> xy                     <span class="co"># data</span></span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">20220314</span>)</span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a>  wi     <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="fu">length</span>(wi), <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>)</span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a>  method <span class="ot">&lt;-</span> <span class="st">"ML"</span>                   <span class="co"># use Maximum Likelihood for estimation</span></span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-36"><a href="#cb51-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Assign values to some of the internal objects</span></span>
<span id="cb51-37"><a href="#cb51-37" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(x)</span>
<span id="cb51-38"><a href="#cb51-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-39"><a href="#cb51-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize weights ------------------------------------------------------------</span></span>
<span id="cb51-40"><a href="#cb51-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-41"><a href="#cb51-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Normalise weights (to sum to 1)</span></span>
<span id="cb51-42"><a href="#cb51-42" aria-hidden="true" tabindex="-1"></a>  wn <span class="ot">&lt;-</span> wi <span class="sc">/</span> <span class="fu">sum</span>(wi)</span>
<span id="cb51-43"><a href="#cb51-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-44"><a href="#cb51-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check they sum to 1</span></span>
<span id="cb51-45"><a href="#cb51-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(wn) <span class="sc">==</span> <span class="dv">1</span></span>
<span id="cb51-46"><a href="#cb51-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-47"><a href="#cb51-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-48"><a href="#cb51-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the weighted means ---------------------------------------------------</span></span>
<span id="cb51-49"><a href="#cb51-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-50"><a href="#cb51-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Center on weighted mean if required</span></span>
<span id="cb51-51"><a href="#cb51-51" aria-hidden="true" tabindex="-1"></a>  center <span class="ot">&lt;-</span> <span class="fu">colSums</span>(wn <span class="sc">*</span> x)</span>
<span id="cb51-52"><a href="#cb51-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-53"><a href="#cb51-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Center X on the weigthed mean</span></span>
<span id="cb51-54"><a href="#cb51-54" aria-hidden="true" tabindex="-1"></a>  x_cent <span class="ot">&lt;-</span> <span class="fu">sweep</span>(x, <span class="dv">2</span>, center, <span class="at">check.margin =</span> <span class="cn">FALSE</span>)</span>
<span id="cb51-55"><a href="#cb51-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-56"><a href="#cb51-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Note that the sweep is subtracting the "center" to each value</span></span>
<span id="cb51-57"><a href="#cb51-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">all.equal</span>(</span>
<span id="cb51-58"><a href="#cb51-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sweep</span>(x, <span class="dv">2</span>, center, <span class="at">check.margin =</span> <span class="cn">FALSE</span>),</span>
<span id="cb51-59"><a href="#cb51-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">t</span>(<span class="fu">apply</span>(x, <span class="dv">1</span>, <span class="cf">function</span> (i) i <span class="sc">-</span> center))</span>
<span id="cb51-60"><a href="#cb51-60" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb51-61"><a href="#cb51-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-62"><a href="#cb51-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-63"><a href="#cb51-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the weighted covariance matrix ---------------------------------------</span></span>
<span id="cb51-64"><a href="#cb51-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-65"><a href="#cb51-65" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Weight (centered) data</span></span>
<span id="cb51-66"><a href="#cb51-66" aria-hidden="true" tabindex="-1"></a>  x_weighted <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(wn) <span class="sc">*</span> x_cent</span>
<span id="cb51-67"><a href="#cb51-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-68"><a href="#cb51-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the ML weigthed covariance matrix manually</span></span>
<span id="cb51-69"><a href="#cb51-69" aria-hidden="true" tabindex="-1"></a>  covwt_man <span class="ot">&lt;-</span> <span class="fu">crossprod</span>(x_weighted)</span>
<span id="cb51-70"><a href="#cb51-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-71"><a href="#cb51-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print the manual weigthed covariance matrix</span></span>
<span id="cb51-72"><a href="#cb51-72" aria-hidden="true" tabindex="-1"></a>  covwt_man</span>
<span id="cb51-73"><a href="#cb51-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-74"><a href="#cb51-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the ML weigthed covariance matrix with stats::cov.wt()</span></span>
<span id="cb51-75"><a href="#cb51-75" aria-hidden="true" tabindex="-1"></a>  covwt_stats <span class="ot">&lt;-</span> <span class="fu">cov.wt</span>(xy, <span class="at">wt =</span> wi, <span class="at">method =</span> <span class="st">"ML"</span>, <span class="at">center =</span> <span class="cn">TRUE</span>)<span class="sc">$</span>cov</span>
<span id="cb51-76"><a href="#cb51-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-77"><a href="#cb51-77" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compare manual and stats weigthed covariance matrices</span></span>
<span id="cb51-78"><a href="#cb51-78" aria-hidden="true" tabindex="-1"></a>  covwt_man <span class="sc">-</span> covwt_stats</span>
<span id="cb51-79"><a href="#cb51-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-80"><a href="#cb51-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternative computations of the unbiased weighted covariance mat -------------</span></span>
<span id="cb51-81"><a href="#cb51-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-82"><a href="#cb51-82" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Literal translation of equation</span></span>
<span id="cb51-83"><a href="#cb51-83" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">sum</span>(wn<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">*</span> <span class="fu">t</span>(wn <span class="sc">*</span> x_cent) <span class="sc">%*%</span> (x_cent)</span>
<span id="cb51-84"><a href="#cb51-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-85"><a href="#cb51-85" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rearrange denominator</span></span>
<span id="cb51-86"><a href="#cb51-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">t</span>(wn <span class="sc">*</span> x_cent) <span class="sc">%*%</span> (x_cent) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">sum</span>(wn<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb51-87"><a href="#cb51-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-88"><a href="#cb51-88" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Spread wn</span></span>
<span id="cb51-89"><a href="#cb51-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">t</span>(<span class="fu">sqrt</span>(wn) <span class="sc">*</span> x_cent) <span class="sc">%*%</span> (<span class="fu">sqrt</span>(wn)<span class="sc">*</span>x_cent) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">sum</span>(wn<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb51-90"><a href="#cb51-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-91"><a href="#cb51-91" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Replace manual cross-product with R cross-product</span></span>
<span id="cb51-92"><a href="#cb51-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">crossprod</span>(<span class="fu">sqrt</span>(wn) <span class="sc">*</span> x_cent)<span class="sc">/</span>(<span class="dv">1</span> <span class="sc">-</span> <span class="fu">sum</span>(wn<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb51-93"><a href="#cb51-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-94"><a href="#cb51-94" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute with stats::cov.wt()</span></span>
<span id="cb51-95"><a href="#cb51-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cov.wt</span>(xy, <span class="at">wt =</span> wi, <span class="at">method =</span> <span class="st">"unbiased"</span>, <span class="at">center =</span> <span class="cn">TRUE</span>)<span class="sc">$</span>cov</span>
<span id="cb51-96"><a href="#cb51-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-97"><a href="#cb51-97" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternative computations of the ML weighted covariance mat -------------------</span></span>
<span id="cb51-98"><a href="#cb51-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-99"><a href="#cb51-99" aria-hidden="true" tabindex="-1"></a>  <span class="co"># R manual cross-product using un-normalised weights</span></span>
<span id="cb51-100"><a href="#cb51-100" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sum</span>(wi) <span class="sc">*</span> <span class="fu">t</span>(wi <span class="sc">*</span> x_cent) <span class="sc">%*%</span> (x_cent)</span>
<span id="cb51-101"><a href="#cb51-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-102"><a href="#cb51-102" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Using the normalised weights</span></span>
<span id="cb51-103"><a href="#cb51-103" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sum</span>(wn) <span class="sc">*</span> <span class="fu">t</span>(wn <span class="sc">*</span> x_cent) <span class="sc">%*%</span> (x_cent)</span>
<span id="cb51-104"><a href="#cb51-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-105"><a href="#cb51-105" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Dropp the term = 1</span></span>
<span id="cb51-106"><a href="#cb51-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">t</span>(wn <span class="sc">*</span> x_cent) <span class="sc">%*%</span> (x_cent)</span>
<span id="cb51-107"><a href="#cb51-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-108"><a href="#cb51-108" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Spread wn</span></span>
<span id="cb51-109"><a href="#cb51-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">t</span>(<span class="fu">sqrt</span>(wn) <span class="sc">*</span> x_cent) <span class="sc">%*%</span> (<span class="fu">sqrt</span>(wn) <span class="sc">*</span> x_cent)</span>
<span id="cb51-110"><a href="#cb51-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-111"><a href="#cb51-111" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Replace manual cross-product with R cross-product</span></span>
<span id="cb51-112"><a href="#cb51-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">crossprod</span>(<span class="fu">sqrt</span>(wn) <span class="sc">*</span> x_cent)</span>
<span id="cb51-113"><a href="#cb51-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-114"><a href="#cb51-114" aria-hidden="true" tabindex="-1"></a>  <span class="co"># R cross-product matrix</span></span>
<span id="cb51-115"><a href="#cb51-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">crossprod</span>(x_weighted)</span>
<span id="cb51-116"><a href="#cb51-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-117"><a href="#cb51-117" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute with stats::cov.wt()</span></span>
<span id="cb51-118"><a href="#cb51-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cov.wt</span>(xy, <span class="at">wt =</span> wi, <span class="at">method =</span> <span class="st">"ML"</span>, <span class="at">center =</span> <span class="cn">TRUE</span>)<span class="sc">$</span>cov</span>
<span id="cb51-119"><a href="#cb51-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-120"><a href="#cb51-120" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtain the matrix of sufficient statistics Tobs ------------------------------</span></span>
<span id="cb51-121"><a href="#cb51-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-122"><a href="#cb51-122" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define a new weigthing object</span></span>
<span id="cb51-123"><a href="#cb51-123" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">20220314</span>)</span>
<span id="cb51-124"><a href="#cb51-124" aria-hidden="true" tabindex="-1"></a>  wi <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="fu">length</span>(wi), <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>)</span>
<span id="cb51-125"><a href="#cb51-125" aria-hidden="true" tabindex="-1"></a>  wn <span class="ot">&lt;-</span> wi <span class="sc">/</span> <span class="fu">sum</span>(wi)</span>
<span id="cb51-126"><a href="#cb51-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-127"><a href="#cb51-127" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the weighted means of X again</span></span>
<span id="cb51-128"><a href="#cb51-128" aria-hidden="true" tabindex="-1"></a>  center <span class="ot">&lt;-</span> <span class="fu">colSums</span>(wn <span class="sc">*</span> x)</span>
<span id="cb51-129"><a href="#cb51-129" aria-hidden="true" tabindex="-1"></a>  x_cent <span class="ot">&lt;-</span> <span class="fu">sweep</span>(x, <span class="dv">2</span>, center, <span class="at">check.margin =</span> <span class="cn">FALSE</span>)</span>
<span id="cb51-130"><a href="#cb51-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-131"><a href="#cb51-131" aria-hidden="true" tabindex="-1"></a>  <span class="co"># "Effective" sample size</span></span>
<span id="cb51-132"><a href="#cb51-132" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">sum</span>(wi)</span>
<span id="cb51-133"><a href="#cb51-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-134"><a href="#cb51-134" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Number of columns</span></span>
<span id="cb51-135"><a href="#cb51-135" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(x)</span>
<span id="cb51-136"><a href="#cb51-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-137"><a href="#cb51-137" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtain matrix of sufficient statistics (Tobs)</span></span>
<span id="cb51-138"><a href="#cb51-138" aria-hidden="true" tabindex="-1"></a>  Tobs_lopp <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, p, p)</span>
<span id="cb51-139"><a href="#cb51-139" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(x)){</span>
<span id="cb51-140"><a href="#cb51-140" aria-hidden="true" tabindex="-1"></a>    Tobs_lopp <span class="ot">&lt;-</span> Tobs_lopp <span class="sc">+</span> wi[i] <span class="sc">*</span> (x_cent[i, ]) <span class="sc">%*%</span> <span class="fu">t</span>(x_cent[i, ])</span>
<span id="cb51-141"><a href="#cb51-141" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb51-142"><a href="#cb51-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-143"><a href="#cb51-143" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtain matrix of sufficient statistics (Tobs) w/ cross-product shortcut</span></span>
<span id="cb51-144"><a href="#cb51-144" aria-hidden="true" tabindex="-1"></a>  Tobs_cp <span class="ot">&lt;-</span> <span class="fu">t</span>(wi <span class="sc">*</span> x_cent) <span class="sc">%*%</span> x_cent</span>
<span id="cb51-145"><a href="#cb51-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-146"><a href="#cb51-146" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compare loop version and cross-product shortcut</span></span>
<span id="cb51-147"><a href="#cb51-147" aria-hidden="true" tabindex="-1"></a>  Tobs_lopp <span class="sc">-</span> Tobs_cp</span>
<span id="cb51-148"><a href="#cb51-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-149"><a href="#cb51-149" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Assign simpler name and print Tobs</span></span>
<span id="cb51-150"><a href="#cb51-150" aria-hidden="true" tabindex="-1"></a>  (Tobs <span class="ot">&lt;-</span> Tobs_cp)</span>
<span id="cb51-151"><a href="#cb51-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-152"><a href="#cb51-152" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert to a covariance matrix</span></span>
<span id="cb51-153"><a href="#cb51-153" aria-hidden="true" tabindex="-1"></a>  covmat <span class="ot">&lt;-</span> Tobs <span class="sc">/</span> n</span>
<span id="cb51-154"><a href="#cb51-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-155"><a href="#cb51-155" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check it's what you were expecting</span></span>
<span id="cb51-156"><a href="#cb51-156" aria-hidden="true" tabindex="-1"></a>  covmat <span class="sc">-</span> <span class="fu">cov.wt</span>(xy, <span class="at">wt =</span> wi, <span class="at">method =</span> <span class="st">"ML"</span>, <span class="at">center =</span> <span class="cn">TRUE</span>)<span class="sc">$</span>cov</span>
<span id="cb51-157"><a href="#cb51-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-158"><a href="#cb51-158" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtain the matrix of sufficient statistics Tobs (normalised weights) ---------</span></span>
<span id="cb51-159"><a href="#cb51-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-160"><a href="#cb51-160" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert to a covariance matrix</span></span>
<span id="cb51-161"><a href="#cb51-161" aria-hidden="true" tabindex="-1"></a>  covmat <span class="sc">-</span> <span class="fu">t</span>(wn <span class="sc">*</span> x_cent) <span class="sc">%*%</span> x_cent</span>
<span id="cb51-162"><a href="#cb51-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-163"><a href="#cb51-163" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Then, covmat relates to Tobs as</span></span>
<span id="cb51-164"><a href="#cb51-164" aria-hidden="true" tabindex="-1"></a>  (<span class="fu">t</span>(wn <span class="sc">*</span> x_cent) <span class="sc">%*%</span> x_cent <span class="sc">*</span> n) <span class="sc">-</span> Tobs_cp</span>
<span id="cb51-165"><a href="#cb51-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-166"><a href="#cb51-166" aria-hidden="true" tabindex="-1"></a>  <span class="co"># So we could say</span></span>
<span id="cb51-167"><a href="#cb51-167" aria-hidden="true" tabindex="-1"></a>  Tobs <span class="ot">&lt;-</span> <span class="fu">t</span>(wn <span class="sc">*</span> x_cent) <span class="sc">%*%</span> x_cent <span class="sc">*</span> n</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } 
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>